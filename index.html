<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pedidos de Reclassificação - Abril</title>

    <!-- Tom Select -->
    <link href="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/css/tom-select.css" rel="stylesheet">

    <style>
        /* ========================== VARIÁVEIS DE TEMA ========================== */
        :root {
            --abril-green: rgb(0, 134, 87);
            --abril-green-dark: rgb(0, 100, 65);
            --text-dark: #333;
            --text-light: #555;
            --background: #FDFDFD;
            --card-bg: #FFF;
            --border: #DDD;
            --success: #28a745;
            --error: #dc3545;
            --shadow-1: 0 2px 5px rgba(0,0,0,0.05);
            --shadow-2: 0 5px 15px rgba(0,0,0,0.08);
        }

        body {
            margin: 0;
            background: var(--background);
            font-family: Inter, system-ui, sans-serif;
            color: var(--text-dark);
        }

        /* ========================== HEADER ========================== */
        header {
            padding: 15px 0;
            background: var(--abril-green);
            box-shadow: 0 5px 10px rgba(0,0,0,0.1);
            display: flex;
            justify-content: center;
        }

        header h1 {
            color: white;
            font-size: 2rem;
            margin: 0;
            font-weight: 300;
        }

        .container {
            max-width: 1000px;
            background: white;
            margin: 25px auto;
            padding: 35px;
            border-radius: 8px;
            box-shadow: var(--shadow-1);
            transition: .2s;
        }

        .container:hover {
            box-shadow: var(--shadow-2);
        }

        h2 {
            font-size: 1.4rem;
            margin-bottom: 20px;
            color: var(--abril-green);
            border-bottom: 1px solid #EEE;
            padding-bottom: 8px;
            display: flex;
            align-items: center;
        }

        /* ========================== FORM ========================== */

        label {
            font-size: .9rem;
            margin-bottom: 6px;
            display: block;
            color: var(--text-light);
        }

        input, select, textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border);
            border-radius: 5px;
            font-size: 1rem;
            background: white;
        }

        input:focus, textarea:focus, select:focus {
            border-color: var(--abril-green);
            box-shadow: 0 0 0 3px rgba(0,134,87,0.15);
            outline: none;
        }

        textarea {
            resize: vertical;
        }

        /* ========================== RATEIO ========================== */

        .rateio-item {
            background: var(--card-bg);
            border: 1px solid #EEE;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 15px;
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .btn-remove {
            background: var(--error);
            color: white;
            border: none;
            padding: 8px 14px;
            border-radius: 4px;
            cursor: pointer;
        }

        .btn-add {
            background: var(--abril-green);
            color: white;
            padding: 12px 20px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            margin-top: 20px;
        }

        /* ========================== MENSAGENS ========================== */

        .msg {
            display: none;
            padding: 15px;
            border-radius: 5px;
            font-weight: 600;
            margin-top: 20px;
        }

        .msg.success { background: #d4edda; color: var(--success); }
        .msg.error   { background: #f8d7da; color: var(--error); }

    </style>
</head>
<body>
<header>
    <h1>Pedidos de Reclassificação</h1>
</header>

<div class="container">

    <form id="mainForm">

        <h2>Dados do Solicitante</h2>

        <label>Solicitante</label>
        <input type="text" id="solicitante" required>

        <label>Email do Solicitante</label>
        <input type="email" id="emailSolicitante" required>

        <h2>Dados do Documento</h2>

        <label>Parceiro</label>
        <input type="text" id="parceiro" required>

        <label>Nº do Documento</label>
        <input type="text" id="docNumero" required>

        <label>Valor Total</label>
        <input type="number" id="valorTotal" step="0.01" required>

        <label>Competência</label>
        <select id="competencia" required></select>

        <label>Anexar Arquivos</label>
        <input type="file" id="fileUpload" multiple>

        <h2>Rateio</h2>

        <div id="rateioContainer"></div>

        <button type="button" class="btn-add" id="addRateio">+ Adicionar Rateio</button>

        <h2>Justificativa</h2>
        <textarea id="justificativa" rows="4" required></textarea>

        <button type="submit" class="btn-add" style="margin-top:25px;">Enviar Pedido</button>

        <div id="msgSuccess" class="msg success">Pedido enviado com sucesso!</div>
        <div id="msgError" class="msg error">Ops! Houve um erro no envio.</div>

    </form>

</div>
    <script src="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/js/tom-select.complete.min.js"></script>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbwrJS1vjpqemqZtl3y9ZeGx-eCF1oQV486c-p01ZtXYpDMLKEpln63aOf-CoQpaBxRB/exec";

/* ============================================================
   Carrega listas iniciais (competência, áreas etc.)
============================================================ */
async function loadInitialData() {
    try {
        const res = await fetch(`${API_URL}?action=get_options`);
        const data = await res.json();

        if (data.result !== "success") throw new Error("Erro ao carregar listas");

        window.cascadingOptions = data.cascadingOptions;
        window.competenciaList = data.fixedLists.competenciaList;
        window.centroList = data.centroData;

        loadCompetencias();
    } 
    catch (err) {
        console.error("Erro ao carregar dados iniciais:", err);
        alert("Não foi possível carregar as listas iniciais.");
    }
}

/* ============================================================
   Preencher competência
============================================================ */
function loadCompetencias() {
    const compSelect = document.getElementById("competencia");

    compSelect.innerHTML = `<option value="">Selecione...</option>`;

    window.competenciaList.forEach(item => {
        compSelect.innerHTML += `<option value="${item}">${item}</option>`;
    });

    new TomSelect(compSelect, { create: false });
}

/* ============================================================
   Criar item de rateio
============================================================ */
function createRateioItem() {
    const div = document.createElement("div");
    div.className = "rateio-item";

    div.innerHTML = `
        <select class="nivel nivel1" placeholder="Nível 1"></select>
        <select class="nivel nivel2" placeholder="Nível 2"></select>
        <select class="nivel nivel3" placeholder="Nível 3"></select>
        <select class="nivel nivel4" placeholder="Nível 4"></select>
        <select class="nivel nivel5" placeholder="Nível 5"></select>

        <select class="centro" placeholder="Centro"></select>

        <input type="number" step="0.01" class="valorRateio" placeholder="Valor">

        <button type="button" class="btn-remove">X</button>
    `;

    setupRateioSelects(div);

    div.querySelector(".btn-remove").addEventListener("click", () => div.remove());

    return div;
}

/* ============================================================
   Configurar selects de rateio
============================================================ */
function setupRateioSelects(container) {
    const nivelSelects = [
        container.querySelector(".nivel1"),
        container.querySelector(".nivel2"),
        container.querySelector(".nivel3"),
        container.querySelector(".nivel4"),
        container.querySelector(".nivel5"),
    ];

    const centroSelect = container.querySelector(".centro");

    populateCascading(nivelSelects);
    populateCentros(centroSelect);

    nivelSelects.forEach(sel => new TomSelect(sel, { create: false }));
    new TomSelect(centroSelect, { create: false });
}

/* ============================================================
   Popular níveis (baseado no seu OPCOES_SHEET)
============================================================ */
function populateCascading(selects) {
    const nivel1 = [...new Set(window.cascadingOptions.map(row => row[0]))];

    fills(selects[0], nivel1);

    selects.forEach((sel, i) => {
        sel.addEventListener("change", () => {
            for (let j = i + 1; j < selects.length; j++) {
                fills(selects[j], []);
                selects[j]._ts?.clearOptions();
            }

            let filtered = window.cascadingOptions;

            for (let k = 0; k <= i; k++) {
                const value = selects[k].value;
                if (value) filtered = filtered.filter(row => row[k] === value);
            }

            if (i + 1 < selects.length) {
                const nextValues = [...new Set(filtered.map(row => row[i + 1]))];
                fills(selects[i + 1], nextValues);
                selects[i + 1]._ts?.addOptions(nextValues.map(v => ({ value: v, text: v })));
            }
        });
    });

    function fills(select, values) {
        select.innerHTML = `<option value="">Selecione...</option>`;
        values.forEach(v => {
            if (v) select.innerHTML += `<option value="${v}">${v}</option>`;
        });
    }
}

/* ============================================================
   Popular centros
============================================================ */
function populateCentros(select) {
    select.innerHTML = `<option value="">Centro</option>`;

    window.centroList.forEach(([nivel2, centro]) => {
        select.innerHTML += `<option value="${centro}">${centro}</option>`;
    });
}

/* ============================================================
   Envio do formulário
============================================================ */
document.getElementById("mainForm").addEventListener("submit", async (e) => {
    e.preventDefault();

    const msgSuccess = document.getElementById("msgSuccess");
    const msgError   = document.getElementById("msgError");

    msgSuccess.style.display = "none";
    msgError.style.display   = "none";

    const formData = new FormData();

    formData.append("solicitante", document.getElementById("solicitante").value);
    formData.append("emailSolicitante", document.getElementById("emailSolicitante").value);

    formData.append("parceiro", document.getElementById("parceiro").value);
    formData.append("docNumero", document.getElementById("docNumero").value);
    formData.append("valorTotal", document.getElementById("valorTotal").value);

    formData.append("competencia", document.getElementById("competencia").value);
    formData.append("justificativa", document.getElementById("justificativa").value);

    /* RATEIO */
    const rateios = [];
    document.querySelectorAll(".rateio-item").forEach(item => {
        rateios.push({
            nivel1: item.querySelector(".nivel1").value,
            nivel2: item.querySelector(".nivel2").value,
            nivel3: item.querySelector(".nivel3").value,
            nivel4: item.querySelector(".nivel4").value,
            nivel5: item.querySelector(".nivel5").value,
            centro: item.querySelector(".centro").value,
            valorRateio: item.querySelector(".valorRateio").value,
        });
    });

    formData.append("rateioJson", JSON.stringify(rateios));

    /* ARQUIVOS */
    const files = document.getElementById("fileUpload").files;
    for (let file of files) {
        formData.append("fileUpload", file);
    }

    try {
        const res = await fetch(API_URL, { method: "POST", body: formData });
        const data = await res.json();

        if (data.result === "success") {
            msgSuccess.style.display = "block";
            e.target.reset();
            return;
        }

        msgError.textContent = data.error || "Erro desconhecido.";
        msgError.style.display = "block";
    } 
    catch (err) {
        console.error(err);
        msgError.textContent = "Erro ao enviar os dados.";
        msgError.style.display = "block";
    }
});

/* ============================================================
   Inicialização
============================================================ */
document.getElementById("addRateio").addEventListener("click", () => {
    document.getElementById("rateioContainer").appendChild(createRateioItem());
});

window.onload = loadInitialData;
</script>

