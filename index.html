<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Sistema de Reclassificação</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
<link href="https://cdn.jsdelivr.net/npm/tom-select/dist/css/tom-select.css" rel="stylesheet" />
<style>
 body { background:#f2f4f3; padding:40px; font-family: "Inter", sans-serif; }
 .card-custom { background:#fff; border-radius:16px; padding:32px; box-shadow:0 4px 20px rgba(0,0,0,0.08); margin-bottom:40px; }
 h2.section-title { font-size:22px; font-weight:700; margin-bottom:20px; display:flex; align-items:center; }
 h2.section-title img { height:1em; margin-left:8px; vertical-align:middle; }
 .btn-main { background:#0f6c3f; color:#fff; border:none; padding:10px 22px; border-radius:10px; font-weight:600; transition:.2s; }
 .btn-main:hover { background:#0c5733; }
 img.iconTree { height:1em; vertical-align:middle; margin-left:6px; }
</style>
</head>
<body>

<div class="card-custom">
  <h2 class="section-title">Rastreamento de Pedidos <img src="A_2D_vector_graphic_of_a_stylized_tree_icon_is_cen.png" class="iconTree" /></h2>

  <div class="row g-3 mb-3">
    <div class="col-md-6"><input id="searchInput" class="form-control" placeholder="Pesquisar Solicitações..." /></div>
    <div class="col-md-3"><button class="btn-main w-100" onclick="searchRequests()">Buscar</button></div>
  </div>

  <div class="table-responsive">
    <table class="table table-bordered" id="resultsTable">
      <thead class="table-light">
        <tr>
          <th>ID</th><th>Solicitante</th><th>Doc Nº</th><th>Competência</th><th>Valor Total</th><th>Status</th><th>Quem Faz</th><th>Descrição</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<div class="card-custom">
  <h2 class="section-title">1. Dados do Solicitante <img src="A_2D_vector_graphic_of_a_stylized_tree_icon_is_cen.png" class="iconTree" /></h2>

  <div class="row g-3 mb-4">
    <div class="col-md-3"><label>Solicitante</label><input id="solicitante" class="form-control" /></div>
    <div class="col-md-3"><label>E-mail</label><input id="email" class="form-control" /></div>
    <div class="col-md-3"><label>Nome Parceiro</label><input id="parceiro" class="form-control" /></div>
    <div class="col-md-3"><label>Nº Documento</label><input id="numDocumento" class="form-control" /></div>
  </div>

  <div class="row g-3 mb-4">
    <div class="col-md-3"><label>Valor Total</label><input id="valorTotal" class="form-control" /></div>
    <div class="col-md-3"><label>Competência</label><select id="competencia" class="form-select"></select></div>
  </div>
</div>

<div class="card-custom">
  <h2 class="section-title">2. Rateio <img src="A_2D_vector_graphic_of_a_stylized_tree_icon_is_cen.png" class="iconTree" /></h2>

  <div id="rateioContainer"></div>
  <button class="btn-main mt-3" onclick="addRateioLinha()">+ Adicionar Rateio</button>
</div>

<div class="text-end">
  <button class="btn-main" onclick="enviarFormulario()">Enviar Pedido</button>
</div>




<script>
const API_URL = "https://script.google.com/macros/s/AKfycbwrJS1vjpqemqZtl3y9ZeGx-eCF1oQV486c-p01ZtXYpDMLKEpln63aOf-CoQpaBxRB/exec";

let listas = {};

window.onload = () => carregarListas();

function carregarListas() {
    fetch(API_URL + "?action=get_options").then(r => r.json()).then(data => {
        listas = data;
        carregarCompetencia(data);
    });
}

function carregarCompetencia(data) {
    const select = document.getElementById("competencia");
    data.fixedLists.competenciaList.forEach(c => {
        let op = document.createElement("option");
        op.value = c;
        op.textContent = c;
        select.appendChild(op);
    });
}

function addRateioLinha() {
    const linha = document.createElement("div");
    linha.className = "rateioLinha row g-3 mb-3";

    linha.innerHTML = `
        <div class="col-md-2"><select class="form-select n1"><option value="">Natureza</option></select></div>
        <div class="col-md-2"><select class="form-select n2"><option value="">Área</option></select></div>
        <div class="col-md-2"><select class="form-select n3"><option value="">N3</option></select></div>
        <div class="col-md-2"><select class="form-select n4"><option value="">N4</option></select></div>
        <div class="col-md-2"><select class="form-select n5"><option value="">N5</option></select></div>
        <div class="col-md-2"><select class="form-select centro"><option value="">Centro</option></select></div>
        <div class="col-md-2"><input class="form-control valor" placeholder="Valor"/></div>
        <div class="col-md-1 text-end"><button class="btn btn-danger" onclick="this.closest('.rateioLinha').remove()">X</button></div>`;

    document.getElementById("rateioContainer").appendChild(linha);
    aplicarCascata(linha);
}

function aplicarCascata(linha) {
    if (!listas.cascadingOptions) return;

    const ops = listas.cascadingOptions;
    const centros = listas.centroData;

    const n1 = linha.querySelector(".n1");
    const n2 = linha.querySelector(".n2");
    const n3 = linha.querySelector(".n3");
    const n4 = linha.querySelector(".n4");
    const n5 = linha.querySelector(".n5");
    const centro = linha.querySelector(".centro");

    function fill(select, arr) {
        select.innerHTML = `<option value=""></option>`;
        [...new Set(arr)].forEach(v => v && (select.innerHTML += `<option value="${v}">${v}</option>`));
    }

    fill(n1, ops.map(r => r[0]));

    n1.onchange = () => {
        fill(n2, ops.filter(r => r[0] === n1.value).map(r => r[1]));
        fill(n3, []); fill(n4, []); fill(n5, []); fill(centro, []);
    };

    n2.onchange = () => {
        fill(n3, ops.filter(r => r[1] === n2.value).map(r => r[2]));
        fill(n4, []); fill(n5, []);
        fill(centro, centros.filter(r => r[0] === n2.value).map(r => r[1]));
    };

    n3.onchange = () => fill(n4, ops.filter(r => r[2] === n3.value).map(r => r[3]));
    n4.onchange = () => fill(n5, ops.filter(r => r[3] === n4.value).map(r => r[4]));
}

function enviarFormulario() {
    let fd = new FormData();

    fd.append("solicitante", solicitante.value);
    fd.append("emailSolicitante", email.value);
    fd.append("parceiro", parceiro.value);
    fd.append("docNumero", numDocumento.value);
    fd.append("valorTotal", valorTotal.value);
    fd.append("competencia", competencia.value);

    let rateios = [];
    document.querySelectorAll('.rateioLinha').forEach(l => {
        rateios.push({
            nivel1: l.querySelector('.n1').value,
            nivel2: l.querySelector('.n2').value,
            nivel3: l.querySelector('.n3').value,
            nivel4: l.querySelector('.n4').value,
            nivel5: l.querySelector('.n5').value,
            centro: l.querySelector('.centro').value,
            valorRateio: l.querySelector('.valor').value
        });
    });

    fd.append("rateioJson", JSON.stringify(rateios));

    fetch(API_URL, { method: "POST", body: fd })
        .then(r => r.json())
        .then(res => alert(res.result === "success" ? "Enviado!" : res.error));
}

function searchRequests() {
    const q = searchInput.value.trim();

    fetch(API_URL + `?action=search_requests&query=${encodeURIComponent(q)}`)
        .then(r => r.json())
        .then(res => {
            const tbody = document.querySelector('#resultsTable tbody');
            tbody.innerHTML = "";
            if (!res.data) return;
            res.data.forEach(r => {
                tbody.innerHTML += `<tr>
                    <td>${r.id}</td>
                    <td>${r.solicitante}</td>
                    <td>${r.docNumero}</td>
                    <td>${r.competencia}</td>
                    <td>${r.valorTotal}</td>
                    <td>${r.status}</td>
                    <td>${r.quemFaz}</td>
                    <td>${r.descricao}</td>
                </tr>`;
            });
        });
}
</script>
</body></html>
