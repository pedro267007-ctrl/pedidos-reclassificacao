<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Sistema de Reclassifica√ß√£o</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
<link href="https://cdn.jsdelivr.net/npm/tom-select/dist/css/tom-select.css" rel="stylesheet" />
<style>
 body { background:#f2f4f3; padding:40px; font-family: "Inter", sans-serif; }
 .card-custom { background:#fff; border-radius:16px; padding:32px; box-shadow:0 4px 20px rgba(0,0,0,0.08); margin-bottom:40px; }
 h2.section-title { font-size:22px; font-weight:700; margin-bottom:20px; display:flex; align-items:center; }
 .btn-main { background:#0f6c3f; color:#fff; border:none; padding:10px 22px; border-radius:10px; font-weight:600; transition:.2s; }
 .btn-main:hover { background:#0c5733; }
 .inline-icon { height:1.2em; vertical-align:middle }
</style>
</head>
<body>

<div class="card-custom">
  <h2 class="section-title">Rastreamento de Pedidos <img src="https://drive.googleusercontent.com/uc?export=view&id=1t--SL4FNglQ32TBhrIsBGY31r3L2GsA8" class="inline-icon" style="margin-left:8px;"></h2>

  <div class="row g-3 mb-3">
    <div class="col-md-6"><input id="searchInput" class="form-control" placeholder="Pesquisar Solicita√ß√µes... (m√≠n. 3 chars)" /></div>
    <div class="col-md-3"><button class="btn-main w-100"> <img src="https://drive.googleusercontent.com/uc?export=view&id=1aDlAiJdKspjMyFqzCvaPkkWJvxjSFMWo" class="inline-icon" style="margin-right:6px;"> Buscar <img src="https://drive.googleusercontent.com/uc?export=view&id=1aDlAiJdKspjMyFqzCvaPkkWJvxjSFMWo" class="inline-icon" style="margin-left:6px;"> </button></div>
  </div>

  <div class="table-responsive">
    <table class="table table-bordered" id="resultsTable">
      <thead class="table-light">
        <tr>
          <th>ID</th><th>Solicitante</th><th>Doc N¬∫</th><th>Compet√™ncia</th><th>Valor Total</th><th>Status</th><th>Quem Faz</th><th>Descri√ß√£o</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<div class="card-custom">
  <h2 class="section-title">1. Dados do Solicitante <img src="https://drive.googleusercontent.com/uc?export=view&id=1t--SL4FNglQ32TBhrIsBGY31r3L2GsA8" class="inline-icon" style="margin-left:8px;"></h2>

  <div class="row g-3 mb-4">
    <div class="col-md-4"><label>Solicitante</label><input id="solicitante" class="form-control" /></div>
    <div class="col-md-4"><label>E-mail</label><input id="email" class="form-control" /></div>
    <div class="col-md-4"><label>Descri√ß√£o do Solicitante</label><textarea id="descricaoSolicitante" class="form-control" rows="2"></textarea></div>
  </div>
</div>

<div class="card-custom">
  <h2 class="section-title">2. Dados do Documento <img src="https://drive.googleusercontent.com/uc?export=view&id=1t--SL4FNglQ32TBhrIsBGY31r3L2GsA8" class="inline-icon" style="margin-left:8px;"></h2>

  <div class="row g-3 mb-4">
    <div class="col-md-3"><label>Nome Parceiro</label><input id="parceiro" class="form-control" /></div>
    <div class="col-md-3"><label>N¬∫ Documento</label><input id="numDocumento" class="form-control" /></div>
    <div class="col-md-3"><label>Valor Total</label><input id="valorTotal" type="number" class="form-control" /></div>
    <div class="col-md-3"><label>Compet√™ncia</label><select id="competencia" class="form-select"></select></div>
  </div>

  <label>Descri√ß√£o do Documento</label>
  <textarea id="descricaoDocumento" class="form-control mb-3" rows="3"></textarea>
</div>

<div class="card-custom">
  <h2 class="section-title">3. Rateio <img src="https://drive.googleusercontent.com/uc?export=view&id=1t--SL4FNglQ32TBhrIsBGY31r3L2GsA8" class="inline-icon" style="margin-left:8px;"></h2>

  <div id="rateioContainer"></div>
  <button class="btn-main w-100"> <img src="https://drive.googleusercontent.com/uc?export=view&id=1aDlAiJdKspjMyFqzCvaPkkWJvxjSFMWo" class="inline-icon" style="margin-right:6px;"> Buscar <img src="https://drive.googleusercontent.com/uc?export=view&id=1aDlAiJdKspjMyFqzCvaPkkWJvxjSFMWo" class="inline-icon" style="margin-left:6px;"> </button>
</div>

<div class="text-end">
  <button class="btn-main w-100"> <img src="https://drive.googleusercontent.com/uc?export=view&id=1aDlAiJdKspjMyFqzCvaPkkWJvxjSFMWo" class="inline-icon" style="margin-right:6px;"> Buscar <img src="https://drive.googleusercontent.com/uc?export=view&id=1aDlAiJdKspjMyFqzCvaPkkWJvxjSFMWo" class="inline-icon" style="margin-left:6px;"> </button>
</div>

<div id="mensagem" class="alert mt-4" style="display:none"></div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/tom-select/dist/js/tom-select.complete.min.js"></script>
<script>
const API_URL = "https://script.google.com/macros/s/AKfycbwrJS1vjpqemqZtl3y9ZeGx-eCF1oQV486c-p01ZtXYpDMLKEpln63aOf-CoQpaBxRB/exec";
let listas = {};

window.onload = () => { carregarListas(); addRateioLinha(); };

function carregarListas(){
 fetch(API_URL + "?action=get_options")
   .then(r => r.json())
   .then(data => { listas = data; carregarCompetencia(data); console.log('DATA RECEBIDA:', data); })
   .catch(err => { console.error('Erro ao carregar listas:', err); mostrarMensagem('danger', 'Erro ao carregar op√ß√µes. Veja console.'); });
}

function carregarCompetencia(data){
 const select = document.getElementById("competencia");
 select.innerHTML = '<option value="">Selecione</option>';
 (data.fixedLists && data.fixedLists.competenciaList || []).forEach(c => {
   const op = document.createElement("option");
   op.value = c; op.textContent = c;
   select.appendChild(op);
 });
}

function addRateioLinha(){
 const linha = document.createElement("div");
 linha.className = "row g-3 mb-3 rateioLinha align-items-end";
 linha.innerHTML = `
   <div class="col-md-2"><label class="form-label visually-hidden">Natureza</label><select class="form-select n1"><option value="">Natureza</option></select></div>
   <div class="col-md-2"><label class="form-label visually-hidden">√Årea</label><select class="form-select n2"><option value="">√Årea</option></select></div>
   <div class="col-md-2"><label class="form-label visually-hidden">N3</label><select class="form-select n3"><option value="">N3</option></select></div>
   <div class="col-md-2"><label class="form-label visually-hidden">N4</label><select class="form-select n4"><option value="">N4</option></select></div>
   <div class="col-md-2"><label class="form-label visually-hidden">N5</label><select class="form-select n5"><option value="">N5</option></select></div>
   <div class="col-md-2"><label class="form-label visually-hidden">Centro</label><select class="form-select centro"><option value="">Centro</option></select></div>
   <div class="col-md-2 mt-2"><input class="form-control valor" type="number" placeholder="Valor" /></div>
   <div class="col-md-1 mt-2 text-end"><button class="btn-main w-100"> <img src="https://drive.googleusercontent.com/uc?export=view&id=1aDlAiJdKspjMyFqzCvaPkkWJvxjSFMWo" class="inline-icon" style="margin-right:6px;"> Buscar <img src="https://drive.googleusercontent.com/uc?export=view&id=1aDlAiJdKspjMyFqzCvaPkkWJvxjSFMWo" class="inline-icon" style="margin-left:6px;"> </button></div>
 `;
 document.getElementById("rateioContainer").appendChild(linha);
 aplicarCascata(linha);
}

function aplicarCascata(linha){
    const n1 = linha.querySelector(".n1");
    const n2 = linha.querySelector(".n2");
    const n3 = linha.querySelector(".n3");
    const n4 = linha.querySelector(".n4");
    const n5 = linha.querySelector(".n5");
    const centro = linha.querySelector(".centro");

    const ops = listas.cascadingOptions || [];
    const centrosLista = listas.centroData || [];

    function preencher(select, valores){
        select.innerHTML = `<option value=""></option>`;
        valores.forEach(v => { if(v) {
            const opt = document.createElement('option'); opt.value = v; opt.textContent = v; select.appendChild(opt);
        }});
    }

    const n1Options = [...new Set(ops.map(r => r[0]).filter(Boolean))];
    preencher(n1, n1Options);

    n1.onchange = () => {
        const n2Options = [...new Set(ops.filter(r => r[0] === n1.value).map(r => r[1]).filter(Boolean))];
        preencher(n2, n2Options);
        preencher(n3, []); preencher(n4, []); preencher(n5, []); preencher(centro, []);
    };

    n2.onchange = () => {
        const cents = centrosLista.filter(r => r[0] === n2.value).map(r => r[1]).filter(Boolean);
        preencher(centro, cents);

        const n3Options = [...new Set(ops.filter(r => r[0] === n1.value && r[1] === n2.value).map(r => r[2]).filter(Boolean))];
        preencher(n3, n3Options);
        preencher(n4, []);
        preencher(n5, []);
    };

    n3.onchange = () => {
        const n4Options = [...new Set(ops.filter(r => r[0] === n1.value && r[1] === n2.value && r[2] === n3.value).map(r => r[3]).filter(Boolean))];
        preencher(n4, n4Options);
        preencher(n5, []);
    };

    n4.onchange = () => {
        const n5Options = [...new Set(ops.filter(r => r[0] === n1.value && r[1] === n2.value && r[2] === n3.value && r[3] === n4.value).map(r => r[4]).filter(Boolean))];
        preencher(n5, n5Options);
    };
}

function enviarFormulario(){
    const valores = [...document.querySelectorAll('.valor')].map(v => parseFloat(v.value) || 0);
    const soma = valores.reduce((a,b)=>a+b,0);
    const total = parseFloat(document.getElementById('valorTotal').value) || 0;

    if(Math.abs(soma - total) > 0.01){
        mostrarMensagem('danger', '‚ùå O total dos rateios deve ser IGUAL ao valor total.');
        return;
    }

    // Monta payload com separa√ß√£o solicitante / documento
    const payload = {
        solicitante: document.getElementById('solicitante').value || '',
        email: document.getElementById('email').value || '',
        descricaoSolicitante: document.getElementById('descricaoSolicitante').value || '',
        parceiro: document.getElementById('parceiro').value || '',
        numDocumento: document.getElementById('numDocumento').value || '',
        valorTotal: total,
        competencia: document.getElementById('competencia').value || '',
        descricaoDocumento: document.getElementById('descricaoDocumento').value || '',
        rateio: [...document.querySelectorAll('.rateioLinha')].map(row => ({
            nivel1: row.querySelector('.n1').value || '',
            nivel2: row.querySelector('.n2').value || '',
            nivel3: row.querySelector('.n3').value || '',
            nivel4: row.querySelector('.n4').value || '',
            nivel5: row.querySelector('.n5').value || '',
            centro: row.querySelector('.centro').value || '',
            valor: parseFloat(row.querySelector('.valor').value) || 0
        }))
    };

    // Envia para API (exemplo). Aqui apenas demo ‚Äî substitua pela sua chamada fetch POST se quiser.
    fetch(API_URL, { method: 'POST', body: JSON.stringify(payload), headers: { 'Content-Type': 'application/json' } })
      .then(r => r.json())
      .then(res => {
         if(res && res.result === 'success'){
           mostrarMensagem('success', `‚úÖ Sucesso! Pedido registrado. ID: <strong>#${res.id || 'n√£o informado'}</strong>`);
           // limpa formul√°rio
           document.getElementById('submission-form')?.reset();
           // remove linhas de rateio
           document.getElementById('rateioContainer').innerHTML = '';
           addRateioLinha();
         } else {
           // Caso o Apps Script retorne texto, tentamos extrair id
           const id = (res && res.id) || 'n√£o informado';
           mostrarMensagem('success', `‚úÖ Sucesso (sem JSON claro). ID: <strong>#${id}</strong>`);
           document.getElementById('rateioContainer').innerHTML = '';
           addRateioLinha();
         }
      })
      .catch(err => {
         console.error('Erro no envio:', err);
         mostrarMensagem('danger', 'Erro ao enviar. Ver console para detalhes.');
      });
}

function mostrarMensagem(tipo, texto){
    const box = document.getElementById('mensagem');
    box.className = 'alert alert-' + tipo;
    box.innerHTML = texto;
    box.style.display = 'block';
}

function searchRequests(){
    const q = (document.getElementById('searchInput').value || '').trim();
    if(q.length < 3){ mostrarMensagem('warning', 'Digite pelo menos 3 caracteres para buscar.'); return; }

    const url = API_URL + '?action=search_requests&query=' + encodeURIComponent(q);
    mostrarMensagem('info', 'üîé Buscando...');

    fetch(url)
      .then(r => r.json())
      .then(data => {
         if(data.result === 'success'){
            renderSearchResults(data.data || []);
            mostrarMensagem('success', `Resultados: ${ (data.data||[]).length }`);
         } else {
            mostrarMensagem('danger', 'Erro na busca: ' + (data.error || 'sem detalhe'));
         }
      })
      .catch(err => { console.error('Erro busca:', err); mostrarMensagem('danger', 'Erro ao buscar. Veja console.'); });
}

function renderSearchResults(results){
    const tbody = document.querySelector('#resultsTable tbody');
    tbody.innerHTML = '';
    if(!results || results.length === 0){ tbody.innerHTML = '<tr><td colspan="8" class="text-center">Nenhum pedido encontrado</td></tr>'; return; }
    results.forEach(item => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>#${item.id || ''}</td>
          <td>${item.solicitante || ''}</td>
          <td>${item.docNumero || ''}</td>
          <td>${item.competencia || ''}</td>
          <td>${(parseFloat(item.valorTotal)||0).toLocaleString('pt-BR',{style:'currency',currency:'BRL'})}</td>
          <td>${item.status || ''}</td>
          <td>${item.quemFaz || ''}</td>
          <td>${item.descricao || ''}</td>
        `;
        tbody.appendChild(tr);
    });
}
</script>
</body>
</html>
