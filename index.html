<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Sistema de Reclassificação</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
<style>
 body { background:#f2f4f3; padding:40px; font-family: "Inter", sans-serif; }
 .card-custom { background:#fff; border-radius:16px; padding:32px; box-shadow:0 4px 20px rgba(0,0,0,0.08); margin-bottom:40px; }
 h2.section-title { font-size:22px; font-weight:700; margin-bottom:20px; display:flex; align-items:center; }
 .btn-main { background:#0f6c3f; color:#fff; border:none; padding:10px 22px; border-radius:10px; font-weight:600; transition:.2s; }
 .btn-main:hover { background:#0c5733; }
 .rateioLinha select { font-size: 0.85rem; }
 .label-suave { font-weight: 600; color: #555; margin-bottom: 5px; display: block; }
</style>
</head>
<body>

<div class="card-custom">
  <h2 class="section-title">Rastreamento de Pedidos </h2>
  <div class="row g-3 mb-3">
    <div class="col-md-6"><input id="searchInput" class="form-control" placeholder="Pesquisar Solicitações... (mín. 3 chars)" /></div>
    <div class="col-md-3"><button class="btn-main w-100" onclick="searchRequests()">Buscar</button></div>
  </div>
  <div class="table-responsive">
    <table class="table table-bordered" id="resultsTable">
      <thead class="table-light">
        <tr>
          <th>ID</th><th>Solicitante</th><th>Doc Nº</th><th>Competência</th><th>Valor Total</th><th>Status</th><th>Quem Faz</th><th>Descrição</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<div class="card-custom">
  <h2 class="section-title">1. Dados do Solicitante </h2>
  <div class="row g-3 mb-4">
    <div class="col-md-6"><label class="label-suave">Solicitante</label><input id="solicitante" class="form-control" /></div>
    <div class="col-md-6"><label class="label-suave">E-mail</label><input id="email" class="form-control" /></div>
  </div>
</div>

<div class="card-custom">
  <h2 class="section-title">2. Dados do Documento </h2>
  <div class="row g-3 mb-4">
    <div class="col-md-3"><label class="label-suave">Nome Parceiro</label><input id="parceiro" class="form-control" /></div>
    <div class="col-md-3"><label class="label-suave">Nº Documento</label><input id="numDocumento" class="form-control" /></div>
    <div class="col-md-3"><label class="label-suave">Valor Total</label><input id="valorTotal" type="number" step="0.01" class="form-control" /></div>
    <div class="col-md-3"><label class="label-suave">Competência</label><select id="competencia" class="form-select"></select></div>
  </div>
  <label class="label-suave">Descrição do Documento</label>
  <textarea id="descricaoDocumento" class="form-control mb-3" rows="2" placeholder="Descreva brevemente o documento..."></textarea>
</div>

<div class="card-custom">
  <h2 class="section-title">3. Rateio </h2>
  <div id="rateioContainer"></div>
  <button class="btn btn-outline-success w-100 mb-4" onclick="addRateioLinha()">+ Adicionar Linha de Rateio</button>
  
  <div class="mt-3">
    <label class="label-suave">Explicação do Rateio / Dúvidas</label>
    <textarea id="explicacaoRateio" class="form-control" rows="3" placeholder="Caso haja alguma dúvida sobre o rateio ou precise explicar a divisão, digite aqui..."></textarea>
  </div>
</div>

<div class="text-end mb-5"><button class="btn-main btn-lg" onclick="enviarFormulario()">Enviar Pedido de Reclassificação</button></div>
<div id="mensagem" class="alert mt-4" style="display:none"></div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
const API_URL = "https://script.google.com/macros/s/AKfycbwrJS1vjpqemqZtl3y9ZeGx-eCF1oQV486c-p01ZtXYpDMLKEpln63aOf-CoQpaBxRB/exec"; 

let listas = { cascadingOptions: [], centroData: [], fixedLists: {} };

window.onload = () => { carregarListas(); };

function carregarListas(){ 
    fetch(API_URL + "?action=get_options")
    .then(r => r.json())
    .then(data => { 
        listas = data; 
        carregarCompetencia(data);
    })
    .catch(err => mostrarMensagem('danger', 'Erro ao carregar opções.'));
}

function carregarCompetencia(data){
 const select = document.getElementById("competencia");
 select.innerHTML = '<option value="">Selecione</option>';
 (data.fixedLists && data.fixedLists.competenciaList || []).forEach(c => {
   const op = document.createElement("option");
   op.value = c; op.textContent = c;
   select.appendChild(op);
 });
}

function addRateioLinha(){
 const container = document.getElementById("rateioContainer");
 const linha = document.createElement("div");
 linha.className = "row g-2 mb-3 rateioLinha align-items-end border-bottom pb-3";
 linha.innerHTML = `
   <div class="col-md-2"><label class="small">Natureza</label><select class="form-select n1"><option value="">Selecione</option></select></div>
   <div class="col-md-2"><label class="small">Área</label><select class="form-select n2"><option value="">Selecione</option></select></div>
   <div class="col-md-2"><label class="small">N3</label><select class="form-select n3"><option value="">Selecione</option></select></div>
   <div class="col-md-2"><label class="small">N4</label><select class="form-select n4"><option value="">Selecione</option></select></div>
   <div class="col-md-1"><label class="small">N5</label><select class="form-select n5"><option value="">Selecione</option></select></div>
   <div class="col-md-2"><label class="small">Centro</label><select class="form-select centro"><option value="">Selecione</option></select></div>
   <div class="col-md-1"><label class="small">Valor</label><input class="form-control valor" type="number" step="0.01" /></div>
   <div class="col-md-1 text-end"><button class="btn btn-outline-danger btn-sm w-100" onclick="this.closest('.rateioLinha').remove()">X</button></div>
 `;
 container.appendChild(linha);
 aplicarCascata(linha);
}

function aplicarCascata(linha){
    const n1 = linha.querySelector(".n1"), n2 = linha.querySelector(".n2"), n3 = linha.querySelector(".n3"),
          n4 = linha.querySelector(".n4"), n5 = linha.querySelector(".n5"), centro = linha.querySelector(".centro");
    const ops = listas.cascadingOptions || [];
    const centrosLista = listas.centroData || [];

    function preencher(select, valores){
        select.innerHTML = `<option value="">Selecione</option>`;
        [...new Set(valores)].filter(Boolean).sort().forEach(v => {
            const opt = document.createElement('option'); opt.value = v; opt.textContent = v; select.appendChild(opt);
        });
    }

    preencher(n1, ops.map(r => r[0]));
    n1.onchange = () => {
        const filtrados = ops.filter(r => r[0] === n1.value);
        preencher(n2, filtrados.map(r => r[1]));
        [n3, n4, n5, centro].forEach(s => preencher(s, []));
    };
    n2.onchange = () => {
        const cents = centrosLista.filter(r => r[0] === n2.value).map(r => r[1]);
        preencher(centro, cents);
        const filtrados = ops.filter(r => r[0] === n1.value && r[1] === n2.value);
        preencher(n3, filtrados.map(r => r[2]));
        [n4, n5].forEach(s => preencher(s, []));
    };
    n3.onchange = () => {
        const filtrados = ops.filter(r => r[0] === n1.value && r[1] === n2.value && r[2] === n3.value);
        preencher(n4, filtrados.map(r => r[3]));
        preencher(n5, []);
    };
    n4.onchange = () => {
        const filtrados = ops.filter(r => r[0] === n1.value && r[1] === n2.value && r[2] === n3.value && r[3] === n4.value);
        preencher(n5, filtrados.map(r => r[4]));
    };
}

function enviarFormulario(){
    const inputTotal = document.getElementById('valorTotal').value;
    const total = parseFloat(inputTotal) || 0;
    const camposValor = [...document.querySelectorAll('.valor')];
    const somaRateio = camposValor.map(v => parseFloat(v.value) || 0).reduce((a,b) => a + b, 0);

    if (camposValor.length > 0 && somaRateio > 0) {
        if (Math.abs(somaRateio - total) > 0.01) {
            mostrarMensagem('danger', `❌ A soma do rateio (${somaRateio.toFixed(2)}) deve ser igual ao valor total (${total.toFixed(2)}).`);
            return;
        }
    }

    mostrarMensagem('info', '⏳ Enviando...');

    // Combinamos a descrição do documento com a explicação do rateio para enviar ao backend
    const descDoc = document.getElementById('descricaoDocumento').value;
    const explRateio = document.getElementById('explicacaoRateio').value;
    const justificativaCompleta = `DOC: ${descDoc} | RATEIO: ${explRateio}`;

    const payload = {
        solicitante: document.getElementById('solicitante').value,
        emailSolicitante: document.getElementById('email').value,
        parceiro: document.getElementById('parceiro').value,
        docNumero: document.getElementById('numDocumento').value,
        valorTotal: total,
        competencia: document.getElementById('competencia').value,
        justificativa: justificativaCompleta,
        rateioJson: [...document.querySelectorAll('.rateioLinha')].map(row => ({
            nivel1: row.querySelector('.n1').value,
            nivel2: row.querySelector('.n2').value,
            nivel3: row.querySelector('.n3').value,
            nivel4: row.querySelector('.n4').value,
            nivel5: row.querySelector('.n5').value,
            centro: row.querySelector('.centro').value,
            valorRateio: parseFloat(row.querySelector('.valor').value) || 0
        }))
    };

    fetch(API_URL, { 
        method: 'POST', 
        headers: { 'Content-Type': 'text/plain;charset=utf-8' },
        body: JSON.stringify(payload) 
    })
    .then(r => r.json())
    .then(res => {
        if(res.result === 'success'){
            mostrarMensagem('success', `✅ Enviado com sucesso! ID: #${res.id}`);
            document.querySelectorAll('input, textarea, select').forEach(i => i.value = '');
            document.getElementById('rateioContainer').innerHTML = '';
        } else {
            mostrarMensagem('danger', 'Erro: ' + res.error);
        }
    })
    .catch(err => mostrarMensagem('danger', 'Erro de conexão com o servidor.'));
}

function mostrarMensagem(tipo, texto){
    const box = document.getElementById('mensagem');
    box.className = 'alert alert-' + tipo;
    box.innerHTML = texto;
    box.style.display = 'block';
}

function searchRequests(){
    const q = document.getElementById('searchInput').value;
    if(q.length < 3) return;
    fetch(API_URL + "?action=search_requests&query=" + encodeURIComponent(q))
    .then(r => r.json())
    .then(data => renderSearchResults(data.data || []));
}

function renderSearchResults(results){
    const tbody = document.querySelector('#resultsTable tbody');
    tbody.innerHTML = results.map(item => `
        <tr>
            <td>#${item.id}</td><td>${item.solicitante}</td><td>${item.docNumero}</td>
            <td>${item.competencia}</td><td>R$ ${item.valorTotal.toFixed(2)}</td>
            <td>${item.status}</td><td>${item.quemFaz}</td><td>${item.descricao}</td>
        </tr>
    `).join('') || '<tr><td colspan="8" class="text-center">Nenhum resultado encontrado.</td></tr>';
}
</script>
</body>
</html>
