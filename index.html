<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Sistema de Reclassificação</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"/>

<style>
body { background:#f2f4f3; padding:40px; font-family:Inter, sans-serif; }
.card-custom { background:#fff; border-radius:16px; padding:32px; box-shadow:0 4px 20px rgba(0,0,0,.08); margin-bottom:40px; }
.btn-main { background:#0f6c3f; color:#fff; border:none; padding:10px 22px; border-radius:10px; font-weight:600 }
.btn-main:hover { background:#0c5733 }
</style>
</head>

<body>

<div class="card-custom">
<h4>Rastreamento de Pedidos</h4>
<div class="row g-3 mb-3">
  <div class="col-md-6">
    <input id="searchInput" class="form-control" placeholder="Pesquisar solicitações (mín. 3 chars)">
  </div>
  <div class="col-md-3">
    <button class="btn-main w-100" onclick="searchRequests()">Buscar</button>
  </div>
</div>

<table class="table table-bordered">
<thead>
<tr>
<th>ID</th><th>Solicitante</th><th>Documento</th><th>Competência</th><th>Valor</th><th>Status</th>
</tr>
</thead>
<tbody id="resultsTable"></tbody>
</table>
</div>

<div class="card-custom">
<h4>Enviar Pedido</h4>

<input id="solicitante" class="form-control mb-2" placeholder="Solicitante">
<input id="email" class="form-control mb-2" placeholder="E-mail">
<input id="numDocumento" class="form-control mb-2" placeholder="Nº Documento">
<input id="valorTotal" type="number" class="form-control mb-2" placeholder="Valor Total">

<button class="btn-main mt-3" onclick="enviarFormulario()">Enviar</button>
</div>

<div id="mensagem" class="alert mt-4" style="display:none"></div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbyeNkxzkyzISud0c307W8qcoxy_FC2SWezvXqjk43zknOduqpBKVV7lleNLV9Dqdi0D/exec";

/* ================= ENVIO (SEM CORS) ================= */
function enviarFormulario(){

  const payload = {
    solicitante: document.getElementById("solicitante").value,
    email: document.getElementById("email").value,
    numDocumento: document.getElementById("numDocumento").value,
    valorTotal: document.getElementById("valorTotal").value
  };

  const formBody = Object.keys(payload)
    .map(k => encodeURIComponent(k) + "=" + encodeURIComponent(payload[k]))
    .join("&");

  fetch(API_URL, {
    method: "POST",
    body: formBody
  })
  .then(r => r.text())
  .then(res => {
    mostrarMensagem("success","✅ Pedido enviado com sucesso!");
  })
  .catch(err => {
    console.error(err);
    mostrarMensagem("danger","❌ Erro ao enviar pedido");
  });
}

/* ================= PESQUISA ================= */
function searchRequests(){
  const q = document.getElementById("searchInput").value.trim();
  if(q.length < 3){ mostrarMensagem("warning","Digite ao menos 3 caracteres"); return; }

  fetch(API_URL + "?action=search_requests&query=" + encodeURIComponent(q))
    .then(r => r.json())
    .then(data => renderSearch(data.data || []))
    .catch(() => mostrarMensagem("danger","Erro na busca"));
}

function renderSearch(data){
  const tbody = document.getElementById("resultsTable");
  tbody.innerHTML = "";

  if(!data.length){
    tbody.innerHTML = `<tr><td colspan="6" class="text-center">Nenhum resultado</td></tr>`;
    return;
  }

  data.forEach(i=>{
    tbody.innerHTML += `
    <tr>
      <td>#${i.id||""}</td>
      <td>${i.solicitante||""}</td>
      <td>${i.docNumero||""}</td>
      <td>${i.competencia||""}</td>
      <td>${i.valorTotal||""}</td>
      <td>${i.status||""}</td>
    </tr>`;
  });
}

function mostrarMensagem(tipo,msg){
  const box = document.getElementById("mensagem");
  box.className = "alert alert-"+tipo;
  box.innerHTML = msg;
  box.style.display = "block";
}
</script>

</body>
</html>
