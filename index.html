<!DOCTYPE html>
<html lang="pt">
<head>
Â  Â  <meta charset="UTF-8">
Â  Â  <meta name="viewport" content="width=device-width, initial-scale=1.0">
Â  Â  <title>Pedido de ReclassificaÃ§Ã£o (Rateio)</title>
Â  Â  <style>
Â  Â  Â  Â  :root {
Â  Â  Â  Â  Â  Â  --primary-color: #005A9C;
Â  Â  Â  Â  Â  Â  --secondary-color: #F7F7F7;
Â  Â  Â  Â  Â  Â  --text-color: #333;
Â  Â  Â  Â  Â  Â  --success-color: #28a745;
Â  Â  Â  Â  Â  Â  --error-color: #dc3545;
Â  Â  Â  Â  }
Â  Â  Â  Â  body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; padding: 0; background-color: var(--secondary-color); color: var(--text-color); }
Â  Â  Â  Â  header { background-color: var(--primary-color); color: white; padding: 20px 0; text-align: center; margin-bottom: 30px; }
Â  Â  Â  Â  .container { max-width: 1200px; margin: auto; padding: 30px; background: white; border-radius: 6px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); }
Â  Â  Â  Â  h2 { color: var(--primary-color); border-bottom: 2px solid #eee; padding-bottom: 10px; margin-bottom: 25px; font-size: 1.5em; }
Â  Â  Â  Â  /* GRID MUDOU PARA 4 COLUNAS POR CAUSA DO NOVO CAMPO EMAIL */
Â  Â  Â  Â  .section-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 25px; }Â 
Â  Â  Â  Â  /* NOVO: Ajuste para acomodar Centro e NÃ­vel 1 no cabeÃ§alho. Mantive 4 colunas */
Â  Â  Â  Â  .header-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 25px; }Â 

Â  Â  Â  Â  .input-group { margin-bottom: 15px; }
Â  Â  Â  Â  label { display: block; margin-bottom: 6px; font-weight: 600; font-size: 0.95em; color: #555; }
Â  Â  Â  Â  input[type="text"], input[type="number"], input[type="email"], select, textarea, input[type="file"] {Â 
Â  Â  Â  Â  Â  Â  width: 100%; padding: 10px 12px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box;Â 
Â  Â  Â  Â  Â  Â  transition: border-color 0.3s; font-size: 1em;
Â  Â  Â  Â  }
Â  Â  Â  Â  input:focus, select:focus, textarea:focus { border-color: var(--primary-color); outline: none; }
Â  Â  Â  Â  textarea { resize: vertical; min-height: 100px; }
Â  Â  Â  Â Â 
Â  Â  Â  Â  /* ESTILOS DA SEÃ‡ÃƒO DE RATEIO (EM LINHA) */
Â  Â  Â  Â  /* ATENÃ‡ÃƒO: CSS AJUSTADO PARA 4 NÃVEIS + VALOR */
Â  Â  Â  Â  .rateio-header { display: flex; font-weight: 600; margin-bottom: 10px; padding: 0 10px; color: var(--primary-color); font-size: 0.9em;}
Â  Â  Â  Â  .rateio-header div { flex-grow: 1; margin-right: 10px; }
Â  Â  Â  Â  .rateio-header .header-valor { flex: 0 0 120px; text-align: right;}Â 
Â  Â  Â  Â  .rateio-header .header-remover { flex: 0 0 30px; }Â 
Â  Â  Â  Â  /* 4 NÃ­veis ocupam 80% e o valor 20% */
Â  Â  Â  Â  .rateio-header .header-niveis { flex-grow: 1; }

Â  Â  Â  Â  .rateio-item { display: flex; gap: 10px; margin-bottom: 15px; border: 1px solid #eee; padding: 10px; border-radius: 4px; align-items: center; }
Â  Â  Â  Â  .rateio-item select, .rateio-item input { flex-grow: 1; }
Â  Â  Â  Â  .rateio-item .select-container { flex-grow: 1; }
Â  Â  Â  Â Â 
Â  Â  Â  Â  .rateio-item .input-valor { flex: 0 0 120px; } /* Ajuste de largura */

Â  Â  Â  Â  .btn-add-line { background-color: #5cb85c; margin-top: 15px; }
Â  Â  Â  Â  .btn-add-line:hover { background-color: #4cae4c; }
Â  Â  Â  Â  .btn-remove-line { background-color: #dc3545; color: white; padding: 8px 10px; border: none; border-radius: 4px; cursor: pointer; flex: 0 0 30px;}
Â  Â  Â  Â  .btn-remove-line:hover { background-color: #c9303d; }

Â  Â  Â  Â  button.btn-submit { background-color: var(--primary-color); color: white; padding: 12px 25px; border: none; border-radius: 4px; cursor: pointer; font-size: 1em; font-weight: bold; transition: background-color 0.3s; width: 100%; margin-top: 25px;}
Â  Â  Â  Â  button.btn-submit:disabled { background-color: #a4c4db; cursor: not-allowed; }
Â  Â  Â  Â  button.btn-submit:hover:not(:disabled) { background-color: #004580; }

Â  Â  Â  Â  .message-box { margin-top: 20px; padding: 15px; border-radius: 4px; font-weight: 600; display: none; }
Â  Â  Â  Â  .success { background-color: #d4edda; color: var(--success-color); border: 1px solid #c3e6cb; }
Â  Â  Â  Â  .error { background-color: #f8d7da; color: var(--error-color); border: 1px solid #f5c6cb; }
Â  Â  Â  Â  .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255, 255, 255, 0.8); display: flex; justify-content: center; align-items: center; z-index: 1000; font-size: 1.2em; color: var(--primary-color); display: none; }

Â  Â  Â  Â  /* NOVO CSS para a seÃ§Ã£o de busca e rastreamento */
Â  Â  Â  Â  .search-container {
Â  Â  Â  Â  Â  Â  max-width: 1200px;
Â  Â  Â  Â  Â  Â  margin-top: 0;Â 
Â  Â  Â  Â  Â  Â  margin-bottom: 30px;
Â  Â  Â  Â  Â  Â  padding: 30px;Â 
Â  Â  Â  Â  Â  Â  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);Â 
Â  Â  Â  Â  }
Â  Â  Â  Â  .search-bar {
Â  Â  Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  Â  Â  gap: 10px;
Â  Â  Â  Â  Â  Â  margin-bottom: 20px;
Â  Â  Â  Â  }
Â  Â  Â  Â  #searchQuery {
Â  Â  Â  Â  Â  Â  flex-grow: 1;
Â  Â  Â  Â  Â  Â  padding: 10px;
Â  Â  Â  Â  }
Â  Â  Â  Â  #btnSearch {
Â  Â  Â  Â  Â  Â  background-color: var(--success-color);
Â  Â  Â  Â  Â  Â  color: white;
Â  Â  Â  Â  Â  Â  padding: 10px 15px;
Â  Â  Â  Â  Â  Â  border: none;
Â  Â  Â  Â  Â  Â  border-radius: 4px;
Â  Â  Â  Â  Â  Â  cursor: pointer;
Â  Â  Â  Â  Â  Â  font-weight: bold;
Â  Â  Â  Â  Â  Â  transition: background-color 0.3s;
Â  Â  Â  Â  }
Â  Â  Â  Â  #btnSearch:hover {
Â  Â  Â  Â  Â  Â  background-color: #1e7e34;
Â  Â  Â  Â  }
Â  Â  Â  Â  .results-table-container {
Â  Â  Â  Â  Â  Â  margin-top: 20px;
Â  Â  Â  Â  }
Â  Â  Â  Â  .results-table {
Â  Â  Â  Â  Â  Â  width: 100%;
Â  Â  Â  Â  Â  Â  border-collapse: collapse;
Â  Â  Â  Â  }
Â  Â  Â  Â  .results-table th, .results-table td {
Â  Â  Â  Â  Â  Â  border: 1px solid #eee;
Â  Â  Â  Â  Â  Â  padding: 10px;
Â  Â  Â  Â  Â  Â  text-align: left;
Â  Â  Â  Â  Â  Â  font-size: 0.9em;
Â  Â  Â  Â  }
Â  Â  Â  Â  .results-table th {
Â  Â  Â  Â  Â  Â  background-color: #f1f1f1;
Â  Â  Â  Â  Â  Â  color: var(--primary-color);
Â  Â  Â  Â  Â  Â  font-weight: 600;
Â  Â  Â  Â  }
Â  Â  Â  Â  .results-table tr:nth-child(even) {
Â  Â  Â  Â  Â  Â  background-color: #f9f9f9;
Â  Â  Â  Â  }
Â  Â  Â  Â  #searchPlaceholder {
Â  Â  Â  Â  Â  Â  text-align: center;
Â  Â  Â  Â  Â  Â  color: #888;
Â  Â  Â  Â  Â  Â  padding: 15px;
Â  Â  Â  Â  }
Â  Â  Â  Â  /* FIM NOVO CSS */
Â  Â  Â  Â Â 
Â  Â  Â  Â  /* ğŸ¨ NOVO CSS para STATUS (Cores e Tags) - MANTIDO ğŸ¨ */
Â  Â  Â  Â  .status-tag {
Â  Â  Â  Â  Â  Â  display: inline-block;
Â  Â  Â  Â  Â  Â  padding: 4px 8px;
Â  Â  Â  Â  Â  Â  border-radius: 12px;
Â  Â  Â  Â  Â  Â  font-size: 0.85em;
Â  Â  Â  Â  Â  Â  font-weight: 700;
Â  Â  Â  Â  Â  Â  white-space: nowrap;
Â  Â  Â  Â  Â  Â  text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.1);
Â  Â  Â  Â  }
Â  Â  Â  Â  .status-pendente { background-color: #ffc107; color: #333; } /* Amarelo */
Â  Â  Â  Â  .status-em_andamento { background-color: #17a2b8; color: white; } /* Azul Claro/Ciano */
Â  Â  Â  Â  .status-finalizado { background-color: #28a745; color: white; } /* Verde */
Â  Â  Â  Â  .status-duvida_enviada { background-color: #fd7e14; color: white; } /* Laranja */
Â  Â  Â  Â  .status-nao_encontrado { background-color: #6c757d; color: white; } /* Cinza (para qualquer outro status) */
Â  Â  Â  Â  /* FIM CSS STATUS */
Â  Â  </style>
</head>
<body>
Â  Â  <div id="loading-overlay" class="loading-overlay">Carregando...</div>
Â  Â  <header>
Â  Â  Â  Â  <h1>FormulÃ¡rio de ReclassificaÃ§Ã£o de Centro/Conta</h1>
Â  Â  </header>

Â  Â  <div class="container search-container">
Â  Â  Â  Â  <h2>4. Rastreamento de Pedidos</h2>
Â  Â  Â  Â  <div class="search-bar">
Â  Â  Â  Â  Â  Â  <input type="text" id="searchQuery" placeholder="Pesquisar por ID ou Solicitante..." />
Â  Â  Â  Â  Â  Â  <button type="button" id="btnSearch">Buscar Pedidos</button>
Â  Â  Â  Â  </div>
Â  Â  Â  Â Â 
Â  Â  Â  Â  <div id="searchResults" class="results-table-container">
Â  Â  Â  Â  Â  Â  <p id="searchPlaceholder">Use o campo acima para buscar pedidos pelo ID (ex: 12345) ou pelo nome do solicitante.</p>
Â  Â  Â  Â  </div>
Â  Â  </div>
Â  Â  <div class="container">
Â  Â  Â  Â  <form id="submission-form" enctype="multipart/form-data">Â 
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  <h2>1. Dados do Solicitante e Documento</h2>
Â  Â  Â  Â  Â  Â  <div class="header-grid">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="input-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="solicitante">Solicitante:</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="solicitante" name="solicitante" required>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="input-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="emailSolicitante">E-mail do Solicitante:</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="email" id="emailSolicitante" name="emailSolicitante" required>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="input-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="parceiro">Nome do Parceiro:</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="parceiro" name="parceiro" required>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="input-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="docNumero">NÂº do Documento/HistÃ³rico:</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="docNumero" name="docNumero" required>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="input-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="valorTotal">Valor Total do Documento (Cheio):</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="number" step="0.01" id="valorTotal" name="valorTotal" required>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="input-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="competencia">CompetÃªncia:</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <select id="competencia" name="competencia" required disabled>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="">Carregando...</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </select>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="input-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="areaDestino">Ãrea Destino:</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <select id="areaDestino" name="areaDestino" required disabled>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="">Carregando...</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </select>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="input-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="nivel1_header">NÃ­vel 1 (Ãrea):</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <select id="nivel1_header" name="nivel1_header" required disabled>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="">Carregando...</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </select>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="input-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="centro">Centro de Custo/Receita*:</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <select id="centro" name="centro" required disabled>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="">Selecione a Ãrea primeiro</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </select>
Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  <h2>2. Detalhamento e Rateio da Conta</h2>
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  <div class="rateio-header">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div style="flex-grow: 2;">Ãrea (N1)</div>
Â  Â  Â  Â  Â  Â  Â  Â  <div style="flex-grow: 2;">N2</div>
Â  Â  Â  Â  Â  Â  Â  Â  <div style="flex-grow: 2;">N3</div>
Â  Â  Â  Â  Â  Â  Â  Â  <div style="flex-grow: 2;">N4</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="header-valor">Valor Rateado</div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="header-remover"></div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  <div id="rateio-container">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  <button type="button" class="btn-add-line" id="add-rateio-line">Fazer Rateio (Adicionar Linha)</button>
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  <input type="hidden" id="numRateios" name="numRateios" value="0">


Â  Â  Â  Â  Â  Â  <h2>3. DescriÃ§Ã£o e Anexos</h2>
Â  Â  Â  Â  Â  Â  <div class="input-group">
Â  Â  Â  Â  Â  Â  Â  Â  <label for="justificativa">DescriÃ§Ã£o Detalhada da ReclassificaÃ§Ã£o:</label>
Â  Â  Â  Â  Â  Â  Â  Â  <textarea id="justificativa" name="justificativa" rows="4" required></textarea>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div class="input-group">
Â  Â  Â  Â  Â  Â  Â  Â  <label for="fileUpload">Anexar Documentos/Fotos (Opcional):</label>
Â  Â  Â  Â  Â  Â  Â  Â  <input type="file" id="fileUpload" name="fileUpload" multiple>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  <button type="submit" class="btn-submit">Enviar Pedido de ReclassificaÃ§Ã£o</button>
Â  Â  Â  Â  Â  Â  <div id="form-message" class="message-box"></div>
Â  Â  Â  Â  </form>
Â  Â  </div>

Â  Â  <script>
Â  Â  Â  Â  // =======================================================================
Â  Â  Â  Â  // ğŸ›‘ COLE O SEU URL DA WEB APP DO APPS SCRIPT AQUI
Â  Â  Â  Â  // =======================================================================
Â  Â  Â  Â  const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbz8H2P6Mur5XroK3kvtuXVppW4-utOEZ4eXm080vLonQwrPey2YhAXBK_50hZl1gqLL/exec';Â 
Â  Â  Â  Â Â 
Â  Â  Â  Â  // VariÃ¡veis de Controle
Â  Â  Â  Â  const submissionForm = document.getElementById("submission-form");
Â  Â  Â  Â  const formMessage = document.getElementById("form-message");
Â  Â  Â  Â  const loadingOverlay = document.getElementById("loading-overlay");
Â  Â  Â  Â  const rateioContainer = document.getElementById('rateio-container');
Â  Â  Â  Â  let allOptionsData = []; // Matriz completa da aba 'Opcoes'
Â  Â  Â  Â  let allFixedLists = {}; // Armazena as listas fixas (incluindo o Centro)

Â  Â  Â  Â  // Mapeamento dos Seletores Fixos (Agora inclui o NÃ­vel 1/Ãrea e o Centro)
Â  Â  Â  Â  const fixedSelects = {
Â  Â  Â  Â  Â  Â  'CompetÃªncia': document.getElementById('competencia'),
Â  Â  Â  Â  Â  Â  'Ãrea Destino': document.getElementById('areaDestino'),Â 
Â  Â  Â  Â  Â  Â  'NÃ­vel 1 (Header)': document.getElementById('nivel1_header'), // Novo
Â  Â  Â  Â  Â  Â  'Centro': document.getElementById('centro') // Novo
Â  Â  Â  Â  };

Â  Â  Â  Â  // =======================================================================
Â  Â  Â  Â  // FUNÃ‡Ã•ES UTILITÃRIAS
Â  Â  Â  Â  // =======================================================================

Â  Â  Â  Â  function showMessage(type, message) {
Â  Â  Â  Â  Â  Â  formMessage.style.display = 'block';
Â  Â  Â  Â  Â  Â  formMessage.className = `message-box ${type}`;
Â  Â  Â  Â  Â  Â  formMessage.innerHTML = message;
Â  Â  Â  Â  }

Â  Â  Â  Â  function populateSelect(selectElement, options, initialText = 'Selecione') {
Â  Â  Â  Â  Â  Â  selectElement.innerHTML = `<option value="" selected>${initialText}</option>`;
Â  Â  Â  Â  Â  Â  const uniqueOptions = [...new Set(options.filter(Boolean))].sort();Â 
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  uniqueOptions.forEach(option => {
Â  Â  Â  Â  Â  Â  Â  Â  const opt = document.createElement('option');
Â  Â  Â  Â  Â  Â  Â  Â  opt.value = option;
Â  Â  Â  Â  Â  Â  Â  Â  opt.textContent = option;
Â  Â  Â  Â  Â  Â  Â  Â  selectElement.appendChild(opt);
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  selectElement.disabled = (uniqueOptions.length === 0);
Â  Â  Â  Â  }

Â  Â  Â  Â  // =======================================================================
Â  Â  Â  Â  // LÃ“GICA DE CASCATA E RATEIO (AJUSTADA PARA 4 NÃVEIS E CENTRO NO HEADER)
Â  Â  Â  Â  // =======================================================================

Â  Â  Â  Â  function createRateioLine() {
Â  Â  Â  Â  Â  Â  const lineId = Date.now(); // ID Ãºnico para a linha
Â  Â  Â  Â  Â  Â  const div = document.createElement('div');
Â  Â  Â  Â  Â  Â  div.className = 'rateio-item';
Â  Â  Â  Â  Â  Â  div.id = `line-${lineId}`;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  let html = '';
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Cria os 4 seletores em cascata (N1, N2, N3, N4)
Â  Â  Â  Â  Â  Â  for (let i = 1; i <= 4; i++) {
Â  Â  Â  Â  Â  Â  Â  Â  html += `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="select-container">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <selectÂ 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  name="nivel${i}"Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  id="nivel${i}-${lineId}"Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  disabledÂ 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  data-level="${i}"Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  data-line-id="${lineId}"
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  >
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="">Carregando NÃ­veis...</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </select>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  // Campo de Input do Valor
Â  Â  Â  Â  Â  Â  html += `
Â  Â  Â  Â  Â  Â  Â  Â  <div class="input-valor">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="number" step="0.01" name="valorRateio" placeholder="Valor" required>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  `;

Â  Â  Â  Â  Â  Â  // BotÃ£o de Remover
Â  Â  Â  Â  Â  Â  html += `
Â  Â  Â  Â  Â  Â  Â  Â  <button type="button" class="btn-remove-line" onclick="removeRateioLine('${div.id}')">X</button>
Â  Â  Â  Â  Â  Â  `;

Â  Â  Â  Â  Â  Â  div.innerHTML = html;
Â  Â  Â  Â  Â  Â  rateioContainer.appendChild(div);

Â  Â  Â  Â  Â  Â  // 1. Inicializa o NÃ­vel 1 desta nova linha
Â  Â  Â  Â  Â  Â  const nivel1Select = document.getElementById(`nivel1-${lineId}`);
Â  Â  Â  Â  Â  Â  // Usa o NÃ­vel 1 do cabeÃ§alho como filtro inicial
Â  Â  Â  Â  Â  Â  const nivel1HeaderValue = document.getElementById('nivel1_header').value;

Â  Â  Â  Â  Â  Â  // Se o NÃ­vel 1 do cabeÃ§alho foi selecionado, use-o como a Ãºnica opÃ§Ã£o.
Â  Â  Â  Â  Â  Â  if (nivel1HeaderValue) {
Â  Â  Â  Â  Â  Â  Â  Â  populateSelect(nivel1Select, [nivel1HeaderValue], 'NÃ­vel 1');
Â  Â  Â  Â  Â  Â  Â  Â  nivel1Select.value = nivel1HeaderValue; // Seta o valor
Â  Â  Â  Â  Â  Â  Â  Â  nivel1Select.disabled = true; // Impede a alteraÃ§Ã£o
Â  Â  Â  Â  Â  Â  Â  Â  // Dispara o filtro para o NÃ­vel 2
Â  Â  Â  Â  Â  Â  Â  Â  filterAndPopulateLine(1, lineId); 
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  // Se nÃ£o, carrega a lista completa de NÃ­vel 1 (como antes, para o caso de esquecer de preencher o header)
Â  Â  Â  Â  Â  Â  Â  Â  const nivel1Options = allOptionsData.map(row => row[0]);
Â  Â  Â  Â  Â  Â  Â  Â  populateSelect(nivel1Select, nivel1Options, 'NÃ­vel 1');
Â  Â  Â  Â  Â  Â  Â  Â  nivel1Select.disabled = false;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  // 2. Adiciona os Event Listeners de CASCATA para esta nova linha (apenas N1 a N3)
Â  Â  Â  Â  Â  Â  for (let i = 1; i <= 3; i++) { // AtÃ© o NÃ­vel 3, pois o NÃ­vel 4 Ã© o Ãºltimo
Â  Â  Â  Â  Â  Â  Â  Â  const currentSelect = document.getElementById(`nivel${i}-${lineId}`);
Â  Â  Â  Â  Â  Â  Â  Â  currentSelect.addEventListener('change', () => filterAndPopulateLine(i, lineId));
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  // Remove a linha do DOM
Â  Â  Â  Â  function removeRateioLine(lineId) {
Â  Â  Â  Â  Â  Â  const line = document.getElementById(lineId);
Â  Â  Â  Â  Â  Â  if (line) {
Â  Â  Â  Â  Â  Â  Â  Â  rateioContainer.removeChild(line);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // FUNÃ‡ÃƒO DE FILTRO TOTALMENTE DEPENDENTE (AJUSTADA PARA 4 NÃVEIS)
Â  Â  Â  Â  function filterAndPopulateLine(currentLevel, lineId) {
Â  Â  Â  Â  Â  Â  const nextLevel = currentLevel + 1;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // --- 1. Limpa e desativa todos os nÃ­veis seguintes (NÃ­vel 5 removido)---
Â  Â  Â  Â  Â  Â  for (let i = nextLevel; i <= 4; i++) { // Vai atÃ© o NÃ­vel 4
Â  Â  Â  Â  Â  Â  Â  Â  const nextSelect = document.getElementById(`nivel${i}-${lineId}`);
Â  Â  Â  Â  Â  Â  Â  Â  if(nextSelect) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  nextSelect.innerHTML = `<option value="" selected>NÃ­vel ${i}</option>`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  nextSelect.disabled = true;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  const nextSelect = document.getElementById(`nivel${nextLevel}-${lineId}`);
Â  Â  Â  Â  Â  Â  if (!nextSelect) return; // Se for o NÃ­vel 4, nÃ£o hÃ¡ prÃ³ximo

Â  Â  Â  Â  Â  Â  // --- 2. Coleta a Cadeia de Filtros ---
Â  Â  Â  Â  Â  Â  const selectedChain = [];
Â  Â  Â  Â  Â  Â  for (let i = 1; i <= currentLevel; i++) {
Â  Â  Â  Â  Â  Â  Â  Â  const select = document.getElementById(`nivel${i}-${lineId}`);
Â  Â  Â  Â  Â  Â  Â  Â  selectedChain.push(select ? select.value : '');Â 
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // --- 3. Aplica o Filtro MÃºltiplo ---
Â  Â  Â  Â  Â  Â  let filteredOptions = allOptionsData;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  for (let i = 0; i < currentLevel; i++) {
Â  Â  Â  Â  Â  Â  Â  Â  const filterValue = selectedChain[i];
Â  Â  Â  Â  Â  Â  Â  Â  const filterIndex = i;

Â  Â  Â  Â  Â  Â  Â  Â  if (filterValue) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  filteredOptions = filteredOptions.filter(row => row[filterIndex] === filterValue);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // A opÃ§Ã£o do prÃ³ximo nÃ­vel estÃ¡ na coluna (nextLevel - 1) na matriz
Â  Â  Â  Â  Â  Â  const nextOptions = filteredOptions.map(row => row[nextLevel - 1]);
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  populateSelect(nextSelect, nextOptions, `NÃ­vel ${nextLevel}`);
Â  Â  Â  Â  Â  Â  nextSelect.disabled = false;
Â  Â  Â  Â  }


Â  Â  Â  Â  // =======================================================================
Â  Â  Â  Â  // LÃ“GICA DE FILTRO DO CENTRO (NOVO)
Â  Â  Â  Â  // =======================================================================

Â  Â  Â  Â  function filterCentro() {
Â  Â  Â  Â  Â  Â  const nivel1HeaderSelect = document.getElementById('nivel1_header');
Â  Â  Â  Â  Â  Â  const centroSelect = document.getElementById('centro');
Â  Â  Â  Â  Â  Â  const nivel1Value = nivel1HeaderSelect.value;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Limpa o Centro e desativa
Â  Â  Â  Â  Â  Â  centroSelect.innerHTML = '<option value="">Selecione a Ãrea primeiro</option>';
Â  Â  Â  Â  Â  Â  centroSelect.disabled = true;

Â  Â  Â  Â  Â  Â  // Assumindo que a planilha 'Listas' ou 'OpÃ§Ãµes' retorna Centro com sua Ãrea (NÃ­vel 1)
Â  Â  Â  Â  Â  Â  if (nivel1Value && allFixedLists.CentroData) {
Â  Â  Â  Â  Â  Â  Â  Â  const filteredCentros = allFixedLists.CentroData
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .filter(item => item.area === nivel1Value) // Filtra pelo NÃ­vel 1 (Area)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .map(item => item.centro); // Pega apenas o nome do Centro
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  populateSelect(centroSelect, filteredCentros, 'Selecione o Centro');
Â  Â  Â  Â  Â  Â  Â  Â  centroSelect.disabled = false;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  // NOVO: TambÃ©m atualiza a primeira linha de rateio se jÃ¡ existir
Â  Â  Â  Â  Â  Â  const firstRateioN1 = document.querySelector('#rateio-container select[name="nivel1"]');
Â  Â  Â  Â  Â  Â  if (firstRateioN1) {
Â  Â  Â  Â  Â  Â  Â  Â  firstRateioN1.value = nivel1Value;
Â  Â  Â  Â  Â  Â  Â  Â  firstRateioN1.disabled = true; // Impede a alteraÃ§Ã£o
Â  Â  Â  Â  Â  Â  Â  Â  // Dispara a cascata para o NÃ­vel 2
Â  Â  Â  Â  Â  Â  Â  Â  const lineId = firstRateioN1.dataset.lineId;
Â  Â  Â  Â  Â  Â  Â  Â  if (nivel1Value) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  filterAndPopulateLine(1, lineId); 
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Limpa os nÃ­veis seguintes se a Ãrea for removida
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  for (let i = 2; i <= 4; i++) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const nextSelect = document.getElementById(`nivel${i}-${lineId}`);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(nextSelect) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  nextSelect.innerHTML = `<option value="" selected>NÃ­vel ${i}</option>`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  nextSelect.disabled = true;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }


Â  Â  Â  Â  // =======================================================================
Â  Â  Â  Â  // LÃ“GICA DE CARREGAMENTO INICIAL (AJUSTADA PARA O NOVO CAMPO CENTRO)
Â  Â  Â  Â  // =======================================================================

Â  Â  Â  Â  async function loadOptionsAndFixedLists() {
Â  Â  Â  Â  Â  Â  loadingOverlay.style.display = 'flex';
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  const response = await fetch(`${APPS_SCRIPT_URL}?action=get_options`);
Â  Â  Â  Â  Â  Â  Â  Â  const data = await response.json();

Â  Â  Â  Â  Â  Â  Â  Â  if (data.result === 'success') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  allOptionsData = data.cascadingOptions;Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  allFixedLists = data.fixedLists; // Armazena as listas fixas

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // 1. Popula listas fixas no cabeÃ§alho (CompetÃªncia e Ãrea Destino)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  for (const header of ['CompetÃªncia', 'Ãrea Destino']) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const options = allFixedLists[header] || [];
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  populateSelect(fixedSelects[header], options, `Selecione a ${header}`);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  fixedSelects[header].disabled = false;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // 2. Popula o NÃ­vel 1/Ãrea (Header) com base na primeira coluna da cascata
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const nivel1HeaderSelect = document.getElementById('nivel1_header');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const nivel1Options = allOptionsData.map(row => row[0]);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  populateSelect(nivel1HeaderSelect, nivel1Options, 'Selecione a Ãrea');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  nivel1HeaderSelect.disabled = false;

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // 3. Adiciona listener de filtro para o Centro
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  nivel1HeaderSelect.addEventListener('change', filterCentro);

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // 4. Cria a primeira linha de rateio
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (rateioContainer.children.length === 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  createRateioLine();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showMessage('error', `Erro ao carregar opÃ§Ãµes: ${data.error || 'Resposta invÃ¡lida do servidor.'}`);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error('Erro ao carregar opÃ§Ãµes:', error);
Â  Â  Â  Â  Â  Â  Â  Â  showMessage('error', 'Falha na conexÃ£o com o Apps Script. Verifique a URL e o Deploy.');
Â  Â  Â  Â  Â  Â  } finally {
Â  Â  Â  Â  Â  Â  Â  Â  loadingOverlay.style.display = 'none';
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  // =======================================================================
Â  Â  Â  Â  // FUNÃ‡ÃƒO 1: Coleta e estrutura os dados de rateio em um array JSON
Â  Â  Â  Â  // =======================================================================
Â  Â  Â  Â  function collectRateioData() {
Â  Â  Â  Â  Â  Â  const rateioLines = document.querySelectorAll('#rateio-container .rateio-item');
Â  Â  Â  Â  Â  Â  const rateioData = [];

Â  Â  Â  Â  Â  Â  rateioLines.forEach(line => {
Â  Â  Â  Â  Â  Â  Â  Â  const data = {};
Â  Â  Â  Â  Â  Â  Â  Â  data.nivel1 = line.querySelector('select[name="nivel1"]').value || '';
Â  Â  Â  Â  Â  Â  Â  Â  data.nivel2 = line.querySelector('select[name="nivel2"]').value || '';
Â  Â  Â  Â  Â  Â  Â  Â  data.nivel3 = line.querySelector('select[name="nivel3"]').value || '';
Â  Â  Â  Â  Â  Â  Â  Â  data.nivel4 = line.querySelector('select[name="nivel4"]').value || '';
Â  Â  Â  Â  Â  Â  Â  Â  // ğŸ›‘ NÃVEL 5 REMOVIDO
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  const valorInput = line.querySelector('input[name="valorRateio"]');
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // ğŸ›‘ CENTRO REMOVIDO DO JSON DE RATEIO
Â  Â  Â  Â  Â  Â  Â  Â  data.valorRateio = valorInput ? parseFloat(valorInput.value) || 0 : 0;
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  rateioData.push(data);
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  return JSON.stringify(rateioData);
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // =======================================================================
Â  Â  Â  Â  // FUNÃ‡ÃƒO 2: LÃ“GICA DE ENVIO DO FORMULÃRIO (doPost) - AJUSTADA
Â  Â  Â  Â  // =======================================================================
Â  Â  Â  Â  submissionForm.addEventListener("submit", async function(event) {
Â  Â  Â  Â  Â  Â  event.preventDefault();Â 
Â  Â  Â  Â  Â  Â  const submitButton = submissionForm.querySelector('button.btn-submit');
Â  Â  Â  Â  Â  Â  const centroValue = document.getElementById('centro').value;

Â  Â  Â  Â  Â  Â  if (!centroValue) {
Â  Â  Â  Â  Â  Â  Â  Â  showMessage('error', 'O campo **Centro de Custo/Receita** Ã© obrigatÃ³rio no cabeÃ§alho.');
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  // âš ï¸ ValidaÃ§Ã£o de Soma (Mantida)
Â  Â  Â  Â  Â  Â  const valorTotalDoc = parseFloat(document.getElementById('valorTotal').value) || 0;
Â  Â  Â  Â  Â  Â  const rateioInputs = document.querySelectorAll('input[name="valorRateio"]');
Â  Â  Â  Â  Â  Â  let somaRateio = 0;
Â  Â  Â  Â  Â  Â  rateioInputs.forEach(input => {
Â  Â  Â  Â  Â  Â  Â  Â  somaRateio += parseFloat(input.value) || 0;
Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  if (Math.abs(valorTotalDoc - somaRateio) > 0.01) {
Â  Â  Â  Â  Â  Â  Â  Â  showMessage('error', `Erro de Rateio: O Valor Total do Documento (${valorTotalDoc.toFixed(2)}) nÃ£o corresponde Ã  soma dos rateios (${somaRateio.toFixed(2)}).`);
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  submitButton.disabled = true;
Â  Â  Â  Â  Â  Â  submitButton.textContent = 'Enviando Pedido...';
Â  Â  Â  Â  Â  Â  showMessage('loading', 'Processando sua solicitaÃ§Ã£o (incluindo anexos, se houver)...');
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Coleta todos os campos
Â  Â  Â  Â  Â  Â  const formData = new FormData(submissionForm);
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Adiciona o JSON do rateio
Â  Â  Â  Â  Â  Â  formData.append('rateioJson', collectRateioData());Â 
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Adiciona o Centro como um parÃ¢metro principal (lido no Apps Script)
Â  Â  Â  Â  Â  Â  formData.append('centro', centroValue); 
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Remove os campos de rateio individuais vazios para evitar poluir o Apps Script
Â  Â  Â  Â  Â  Â  const rateioLineFields = ['nivel1', 'nivel2', 'nivel3', 'nivel4', 'nivel5', 'valorRateio'];
Â  Â  Â  Â  Â  Â  rateioLineFields.forEach(name => formData.delete(name));
Â  Â  Â  Â  Â  Â  formData.delete('numRateios'); 
Â  Â  Â  Â  Â  Â  formData.delete('nivel1_header'); // Remove o NÃ­vel 1 do header (agora Ã© apenas filtro)
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  const response = await fetch(APPS_SCRIPT_URL, {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  method: 'POST',Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  body: formData
Â  Â  Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  Â  Â  if (!response.ok) { throw new Error('Erro de rede ou servidor Apps Script.'); }
Â  Â  Â  Â  Â  Â  Â  Â  const responseData = await response.json();

Â  Â  Â  Â  Â  Â  Â  Â  if (responseData && responseData.result === "success") {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Mensagem de sucesso atualizada
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showMessage('success', `âœ… Sucesso! Seu pedido foi registrado. ID do Documento: **#${responseData.id}**. Seus anexos foram salvos.`);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  submissionForm.reset();Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  rateioContainer.innerHTML = '';Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  loadOptionsAndFixedLists();Â 
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  throw new Error(responseData.error || "Resposta inesperada do servidor Apps Script.");
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error('Erro:', error);
Â  Â  Â  Â  Â  Â  Â  Â  showMessage('error', "Ops! Houve um erro no envio. Verifique a URL do Apps Script, o Deploy e o console do navegador.");
Â  Â  Â  Â  Â  Â  } finally {
Â  Â  Â  Â  Â  Â  Â  Â  submitButton.disabled = false;
Â  Â  Â  Â  Â  Â  Â  Â  submitButton.textContent = 'Enviar Pedido de ReclassificaÃ§Ã£o';
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });

Â  Â  Â  Â  // =======================================================================
Â  Â  Â  Â  // LÃ“GICA DE BUSCA E RASTREAMENTO (Mantida)
Â  Â  Â  Â  // =======================================================================
Â  Â  Â  Â  const btnSearch = document.getElementById('btnSearch');
Â  Â  Â  Â  const searchQueryInput = document.getElementById('searchQuery');
Â  Â  Â  Â  const searchResultsDiv = document.getElementById('searchResults');

Â  Â  Â  Â  btnSearch.addEventListener('click', handleSearch);
Â  Â  Â  Â  searchQueryInput.addEventListener('keypress', function (e) {
Â  Â  Â  Â  Â  Â  if (e.key === 'Enter') {
Â  Â  Â  Â  Â  Â  Â  Â  e.preventDefault();
Â  Â  Â  Â  Â  Â  Â  Â  handleSearch();
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });

Â  Â  Â  Â  async function handleSearch() {
Â  Â  Â  Â  Â  Â  const query = searchQueryInput.value.trim();

Â  Â  Â  Â  Â  Â  if (query.length < 3) {
Â  Â  Â  Â  Â  Â  Â  Â  searchResultsDiv.innerHTML = '<p class="error message-box">Digite pelo menos **3 caracteres** (ID ou Nome) para buscar.</p>';
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  btnSearch.disabled = true;
Â  Â  Â  Â  Â  Â  btnSearch.textContent = 'Buscando...';
Â  Â  Â  Â  Â  Â  searchResultsDiv.innerHTML = '<p id="searchPlaceholder">Aguarde, pesquisando no sistema...</p>';

Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  // Chama a funÃ§Ã£o search_requests no Apps Script
Â  Â  Â  Â  Â  Â  Â  Â  const url = `${APPS_SCRIPT_URL}?action=search_requests&query=${encodeURIComponent(query)}`;
Â  Â  Â  Â  Â  Â  Â  Â  const response = await fetch(url);
Â  Â  Â  Â  Â  Â  Â  Â  const data = await response.json();

Â  Â  Â  Â  Â  Â  Â  Â  if (data.result === 'success') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  renderSearchResults(data.data);
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  searchResultsDiv.innerHTML = `<p class="error message-box">Erro: ${data.error || 'Falha ao buscar dados.'}</p>`;
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error('Erro na busca:', error);
Â  Â  Â  Â  Â  Â  Â  Â  searchResultsDiv.innerHTML = '<p class="error message-box">Falha na conexÃ£o com o Apps Script ou erro de rede.</p>';
Â  Â  Â  Â  Â  Â  } finally {
Â  Â  Â  Â  Â  Â  Â  Â  btnSearch.disabled = false;
Â  Â  Â  Â  Â  Â  Â  Â  btnSearch.textContent = 'Buscar Pedidos';
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // ğŸ§  FUNÃ‡ÃƒO: Mapeia o status para emoji e cor (Mantida)
Â  Â  Â  Â  function getStatusInfo(status) {
Â  Â  Â  Â  Â  Â  // Normaliza o status (remove acentos, espaÃ§os e transforma em lowercase)
Â  Â  Â  Â  Â  Â  const s = status ? status.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/[^a-z0-9]+/g, '_') : 'nao_encontrado';
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  switch (s) {
Â  Â  Â  Â  Â  Â  Â  Â  case 'pendente':
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return { emoji: 'â³', class: 'status-pendente', label: 'Pendente' };
Â  Â  Â  Â  Â  Â  Â  Â  case 'em_andamento':
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return { emoji: 'âš™ï¸', class: 'status-em_andamento', label: 'Em Andamento' };
Â  Â  Â  Â  Â  Â  Â  Â  case 'finalizado':
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return { emoji: 'âœ…', class: 'status-finalizado', label: 'Finalizado' };
Â  Â  Â  Â  Â  Â  Â  Â  case 'duvida_enviada_no_email_do_solicitante':
Â  Â  Â  Â  Â  Â  Â  Â  case 'duvida_enviada': // Adicionando uma variaÃ§Ã£o mais curta para seguranÃ§a
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return { emoji: 'ğŸ“§', class: 'status-duvida_enviada', label: 'DÃºvida Enviada' };
Â  Â  Â  Â  Â  Â  Â  Â  default:
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return { emoji: 'â“', class: 'status-nao_encontrado', label: status || 'Status Indefinido' };
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  // ğŸ§  FUNÃ‡ÃƒO: Renderiza resultados (Mantida)
Â  Â  Â  Â  function renderSearchResults(results) {
Â  Â  Â  Â  Â  Â  if (results.length === 0) {
Â  Â  Â  Â  Â  Â  Â  Â  searchResultsDiv.innerHTML = '<p id="searchPlaceholder">Nenhum pedido encontrado com este critÃ©rio.</p>';
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  let html = '<table class="results-table">';
Â  Â  Â  Â  Â  Â  html += `
Â  Â  Â  Â  Â  Â  Â  Â  <thead>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <tr>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>ID</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>Solicitante</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>CompetÃªncia </th> <th>Valor Total</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>Status </th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>Quem EstÃ¡ Fazendo </th>Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>DescriÃ§Ã£o / Justificativa </th>Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </tr>
Â  Â  Â  Â  Â  Â  Â  Â  </thead>
Â  Â  Â  Â  Â  Â  Â  Â  <tbody>
Â  Â  Â  Â  Â  Â  `;

Â  Â  Â  Â  Â  Â  results.forEach(item => {
Â  Â  Â  Â  Â  Â  Â  Â  // FormataÃ§Ã£o de valor para Real Brasileiro
Â  Â  Â  Â  Â  Â  Â  Â  const valorFormatado = (parseFloat(item.valorTotal) || 0).toFixed(2).replace('.', ',');
Â  Â  Â  Â  Â  Â  Â  Â  const statusInfo = getStatusInfo(item.status); // Pega as informaÃ§Ãµes de status e formataÃ§Ã£o

Â  Â  Â  Â  Â  Â  Â  Â  html += `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <tr>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td><strong>#${item.id}</strong></td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td>${item.solicitante}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td>${item.competencia}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td>R$ ${valorFormatado}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="status-tag ${statusInfo.class}">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${statusInfo.emoji} ${statusInfo.label}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td>${item.quemFaz || 'N/A'}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td>${item.descricao || 'N/A'}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </tr>
Â  Â  Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  html += '</tbody></table>';
Â  Â  Â  Â  Â  Â  searchResultsDiv.innerHTML = html;
Â  Â  Â  Â  }


Â  Â  Â  Â  // =======================================================================
Â  Â  Â  Â  // INICIALIZAÃ‡ÃƒO E EVENTOS
Â  Â  Â  Â  // =======================================================================
Â  Â  Â  Â  document.getElementById('add-rateio-line').addEventListener('click', () => {
Â  Â  Â  Â  Â  Â  // O NÃ­vel 1 da linha de rateio Ã© dependente do NÃ­vel 1 do cabeÃ§alho
Â  Â  Â  Â  Â  Â  if (!document.getElementById('nivel1_header').value) {
Â  Â  Â  Â  Â  Â  Â  Â  showMessage('error', 'âš ï¸ Por favor, selecione primeiro a **Ãrea (NÃ­vel 1)** no cabeÃ§alho do documento.');
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  createRateioLine();
Â  Â  Â  Â  });
Â  Â  Â  Â  document.addEventListener('DOMContentLoaded', loadOptionsAndFixedLists);

Â  Â  </script>
</body>
</html>
