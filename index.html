<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Pedidos de Reclassifica√ß√£o</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

<style>
body { background:#f2f4f3; padding:40px; font-family:Inter,sans-serif }
.card { border-radius:16px; box-shadow:0 4px 18px rgba(0,0,0,.08); padding:32px; margin-bottom:40px }
.btn-main { background:#0f6c3f; color:#fff; border:none; border-radius:10px; padding:10px 22px; font-weight:600 }
.btn-main:hover { background:#0c5733 }
.rateio-row input { margin-bottom:6px }
</style>
</head>

<body>

<!-- ================= PESQUISA ================= -->
<div class="card">
<h4>üîç Pesquisa de Solicita√ß√µes</h4>
<div class="row g-3">
  <div class="col-md-6">
    <input id="searchInput" class="form-control" placeholder="Buscar por ID, solicitante ou documento">
  </div>
  <div class="col-md-3">
    <button class="btn-main w-100" onclick="buscar()">Buscar</button>
  </div>
</div>

<table class="table table-bordered mt-4">
<thead>
<tr>
<th>ID</th><th>Solicitante</th><th>Documento</th><th>Compet√™ncia</th><th>Valor</th><th>Status</th>
</tr>
</thead>
<tbody id="resultadoBusca"></tbody>
</table>
</div>

<!-- ================= FORMUL√ÅRIO ================= -->
<div class="card">
<h4>üìÑ Novo Pedido</h4>

<form id="rateioForm"
      action="https://script.google.com/macros/s/AKfycbyeNkxzkyzISud0c307W8qcoxy_FC2SWezvXqjk43zknOduqpBKVV7lleNLV9Dqdi0D/exec"
      method="POST">

<input name="solicitante" id="solicitante" class="form-control mb-2" placeholder="Solicitante">
<input name="emailSolicitante" id="emailSolicitante" class="form-control mb-2" placeholder="E-mail">
<input name="docNumero" id="docNumero" class="form-control mb-2" placeholder="N¬∫ Documento">
<input name="competencia" id="competencia" class="form-control mb-2" placeholder="Compet√™ncia (MM/AAAA)">
<input name="valorTotal" id="valorTotal" type="number" class="form-control mb-2" placeholder="Valor Total">

<hr>
<h5>üìä Rateio</h5>

<div id="rateios"></div>

<button type="button" class="btn btn-secondary mb-3" onclick="addRateio()">‚ûï Adicionar Rateio</button>

<textarea name="justificativa" id="justificativa" class="form-control mb-3" placeholder="Justificativa"></textarea>

<!-- üîë CAMPO CR√çTICO -->
<input type="hidden" name="rateioJson" id="rateioJson">

<button type="submit" class="btn-main" onclick="prepararEnvioRateio()">Enviar Solicita√ß√£o</button>

</form>
</div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbyeNkxzkyzISud0c307W8qcoxy_FC2SWezvXqjk43zknOduqpBKVV7lleNLV9Dqdi0D/exec";

/* ================= RATEIO ================= */
function addRateio(){
  const div = document.createElement("div");
  div.className = "rateio-row border p-3 mb-2 rounded";

  div.innerHTML = `
    <input class="form-control" placeholder="N√≠vel 1">
    <input class="form-control" placeholder="N√≠vel 2">
    <input class="form-control" placeholder="N√≠vel 3">
    <input class="form-control" placeholder="N√≠vel 4">
    <input class="form-control" placeholder="N√≠vel 5">
    <input class="form-control" placeholder="Centro">
    <input type="number" class="form-control" placeholder="Valor">
    <button type="button" class="btn btn-sm btn-danger mt-2" onclick="this.parentElement.remove()">Remover</button>
  `;
  document.getElementById("rateios").appendChild(div);
}

/* ================= ENVIO (CORRIGIDO) ================= */
function prepararEnvioRateio(){

  const rateioData = [];

  document.querySelectorAll(".rateio-row").forEach(row => {
    const campos = row.querySelectorAll("input");
    rateioData.push({
      nivel1: campos[0].value || "",
      nivel2: campos[1].value || "",
      nivel3: campos[2].value || "",
      nivel4: campos[3].value || "",
      nivel5: campos[4].value || "",
      centro: campos[5].value || "",
      valorRateio: Number(campos[6].value || 0)
    });
  });

  console.log("RATEIO ENVIADO:", rateioData);

  document.getElementById("rateioJson").value =
    JSON.stringify(rateioData);
}

/* ================= PESQUISA ================= */
function buscar(){
  const q = searchInput.value.trim();
  if(q.length < 3) return;

  fetch(API_URL+"?action=search_requests&query="+encodeURIComponent(q))
    .then(r=>r.json())
    .then(d=>{
      resultadoBusca.innerHTML="";
      d.data.forEach(i=>{
        resultadoBusca.innerHTML += `
        <tr>
          <td>${i.id}</td>
          <td>${i.solicitante}</td>
          <td>${i.docNumero}</td>
          <td>${i.competencia}</td>
          <td>${i.valorTotal}</td>
          <td>${i.status}</td>
        </tr>`;
      });
    });
}
</script>

</body>
</html>
