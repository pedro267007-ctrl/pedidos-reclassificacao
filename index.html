<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de ReclassificaÃ§Ãµes</title>
    <link href="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/css/tom-select.css" rel="stylesheet">
    <style>
        body { margin:0; background:#f6f7f9; font-family:Inter, sans-serif; }
        header { background:#ffffff; padding:30px; border-bottom:2px solid #e5e7eb; }
        header h1 { margin:0; font-size:1.9rem; color:#008657; }

        .page-container { max-width:1300px; margin:40px auto; background:white; padding:40px; border-radius:12px; box-shadow:0 4px 15px rgba(0,0,0,0.06); }

        /* TÃ­tulo de seÃ§Ã£o */
        .section-title { font-size:1.4rem; font-weight:600; color:#008657; margin-bottom:15px; display:flex; align-items:center; gap:10px; }
        .section-title::after { content:""; flex:1; height:1px; background:#e5e7eb; }

        /* Barra de busca */
        .search-area { margin-bottom:40px; }
        .search-group { display:flex; gap:10px; }
        .search-input { flex:1; padding:14px; border:1px solid #d1d5db; border-radius:8px; font-size:1rem; }
        .search-btn { padding:14px 25px; background:#008657; color:white; border:none; border-radius:8px; cursor:pointer; }

        /* Tabela de resultados */
        table { width:100%; border-collapse:collapse; margin-top:20px; }
        th { background:#008657; color:white; padding:12px; text-align:left; font-weight:600; }
        td { padding:12px; border-bottom:1px solid #e5e7eb; }

        .status-pill { padding:6px 12px; border-radius:20px; font-weight:600; font-size:0.85rem; display:inline-flex; align-items:center; gap:6px; }
        .pendente { background:#fde68a; color:#92400e; }
        .aprovado { background:#bbf7d0; color:#065f46; }

        /* FormulÃ¡rio */
        .form-grid { display:grid; grid-template-columns:repeat(2, 1fr); gap:20px; margin-top:20px; }
        label { font-size:0.9rem; color:#374151; }
        input, select, textarea { width:100%; padding:12px; border:1px solid #d1d5db; border-radius:8px; margin-top:4px; }

        .rateio-table { margin-top:20px; }
        .rateio-header { display:grid; grid-template-columns:repeat(7,1fr); background:#008657; color:white; padding:12px; border-radius:8px 8px 0 0; }
        .rateio-row { display:grid; grid-template-columns:repeat(7,1fr); gap:10px; background:#f9fafb; padding:12px; border-bottom:1px solid #e5e7eb; }
        .remove-rateio { background:#dc2626; color:white; border:none; padding:8px; border-radius:6px; cursor:pointer; }
        .add-rateio { margin-top:20px; background:#006745; color:white; padding:14px; border:none; width:100%; border-radius:8px; cursor:pointer; }

        .submit-btn { margin-top:30px; background:#008657; color:white; padding:16px; border:none; border-radius:10px; width:100%; font-size:1rem; cursor:pointer; }

        .msg-success, .msg-error { padding:14px; border-radius:8px; margin-top:20px; display:none; font-weight:600; }
        .msg-success { background:#d1fae5; color:#065f46; }
        .msg-error { background:#fee2e2; color:#991b1b; }

    </style>
</head>
<body>
<header>
    <h1>Sistema de ReclassificaÃ§Ãµes</h1>
</header>

<div class="page-container">

    <!-- Barra de Pesquisa -->
    <div class="section-title">Rastreamento de Pedidos ðŸŒ¿</div>
    <div class="search-area">
        <div class="search-group">
            <input id="searchInput" class="search-input" placeholder="Buscar por ID, solicitante ou NÂº documento...">
            <button class="search-btn" id="searchBtn">Buscar</button>
        </div>
        <table id="resultsTable">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Solicitante</th>
                    <th>Doc NÂº</th>
                    <th>CompetÃªncia</th>
                    <th>Valor Total</th>
                    <th>Status</th>
                    <th>Quem Faz</th>
                    <th>DescriÃ§Ã£o</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <!-- FormulÃ¡rio -->
    <div class="section-title">1. Dados do Solicitante e Documento ðŸŒ¿</div>

    <form id="mainForm">

        <div class="form-grid">
            <div>
                <label>Solicitante</label>
                <input id="solicitante" required>
            </div>
            <div>
                <label>E-mail do Solicitante</label>
                <input id="emailSolicitante" type="email" required>
            </div>
            <div>
                <label>Nome do Parceiro</label>
                <input id="parceiro" required>
            </div>
            <div>
                <label>NÂ° do Documento/HistÃ³rico</label>
                <input id="docNumero" required>
            </div>
            <div>
                <label>Valor Total do Documento</label>
                <input id="valorTotal" type="number" step="0.01" required>
            </div>
            <div>
                <label>CompetÃªncia</label>
                <select id="competencia" required></select>
            </div>
        </div>

        <label style="margin-top:25px;">Anexos</label>
        <input type="file" id="fileUpload" multiple>

        <div class="section-title" style="margin-top:40px;">2. Detalhamento e Rateio da Conta ðŸŒ¿</div>

        <div class="rateio-table">
            <div class="rateio-header">
                <div>NÃ­vel 1</div><div>NÃ­vel 2</div><div>NÃ­vel 3</div><div>NÃ­vel 4</div><div>NÃ­vel 5</div><div>Centro</div><div>Valor</div>
            </div>
            <div id="rateioContainer"></div>
            <button type="button" class="add-rateio" id="addRateio">Fazer Rateio (Adicionar Linha)</button>
        </div>

        <label style="margin-top:25px;">Justificativa</label>
        <textarea id="justificativa" rows="4" required></textarea>

        <button class="submit-btn" type="submit">Enviar Pedido</button>

        <div id="msgSuccess" class="msg-success">Pedido enviado com sucesso!</div>
        <div id="msgError" class="msg-error">Erro ao enviar pedido.</div>

    </form>

</div>

<script src="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/js/tom-select.complete.min.js"></script>
<script>
const API_URL = "https://script.google.com/macros/s/AKfycbwrJS1vjpqemqZtl3y9ZeGx-eCF1oQV486c-p01ZtXYpDMLKEpln63aOf-CoQpaBxRB/exec";

/* ================= INICIALIZAÃ‡ÃƒO ================= */
window.onload = () => { loadInitialData(); addRateioLine(); };

document.getElementById("addRateio").addEventListener("click", addRateioLine);
document.getElementById("searchBtn").addEventListener("click", doSearch);
document.getElementById("searchInput").addEventListener("keyup", (e)=>{ if(e.key==="Enter") doSearch(); });
document.getElementById("mainForm").addEventListener("submit", submitForm);

/* ================= CARREGAR LISTAS ================= */
async function loadInitialData(){
    try{
        const res = await fetch(`${API_URL}?action=get_options`);
        const data = await res.json();

        window.cascadingOptions = data.cascadingOptions;
        window.competenciaList = data.fixedLists.competenciaList;
        window.centroList = data.centroData;

        loadCompetencias();
    }catch(err){ console.error(err); }
}

function loadCompetencias(){
    const comp = document.getElementById("competencia");
    comp.innerHTML = `<option value="">Selecione a CompetÃªncia</option>`;
    window.competenciaList.forEach(c=> comp.innerHTML += `<option value="${c}">${c}</option>`);
    new TomSelect(comp,{create:false});
}

/* ================= BUSCA ================= */
async function doSearch(){
    const q = document.getElementById("searchInput").value.trim();
    const tbody = document.querySelector("#resultsTable tbody");
    tbody.innerHTML = "";

    if(!q){ return; }

    const res = await fetch(`${API_URL}?action=search_requests&query=${encodeURIComponent(q)}`);
    const data = await res.json();

    if(data.result !== "success") return;

    data.data.forEach(row=>{
        const statusClass = row.status.toLowerCase()==="pendente" ? "pendente" : "aprovado";
        tbody.innerHTML += `
            <tr>
                <td>#${row.id}</td>
                <td>${row.solicitante}</td>
                <td>${row.docNumero}</td>
                <td>${row.competencia}</td>
                <td>R$ ${row.valorTotal.toFixed(2)}</td>
                <td><span class="status-pill ${statusClass}">${row.status}</span></td>
                <td>${row.quemFaz}</td>
                <td>${row.descricao}</td>
            </tr>
        `;
    });
}

/* ================= RATEIO ================= */
function addRateioLine(){
    const c = document.getElementById("rateioContainer");
    const div = document.createElement("div");
    div.className = "rateio-row";

    div.innerHTML = `
        <select class="n1"></select>
        <select class="n2"></select>
        <select class="n3"></select>
        <select class="n4"></select>
        <select class="n5"></select>
        <select class="centro"></select>
        <input type="number" class="valorRateio" step="0.01">
        <button type="button" class="remove-rateio" onclick="this.parentElement.remove()">X</button>
    `;

    c.appendChild(div);
    setupRateio(div);
}

function setupRateio(div){
    const selects = [".n1", ".n2", ".n3", ".n4", ".n5"].map(s=> div.querySelector(s));
    const centroSel = div.querySelector(".centro");

    fill(selects[0], [...new Set(window.cascadingOptions.map(r=>r[0]))]);

    selects.forEach((sel,idx)=>{
        new TomSelect(sel,{create:false});
        sel.addEventListener("change",()=>{
            for(let i=idx+1;i<selects.length;i++){ fill(selects[i],[]); selects[i]._ts.clearOptions(); }

            let filtered = window.cascadingOptions;
            for(let i=0;i<=idx;i++){
                const v = selects[i].value;
                if(v) filtered = filtered.filter(r=> r[i]===v);
            }

            if(idx+1 < selects.length){
                const nextVals = [...new Set(filtered.map(r=> r[idx+1]))].filter(Boolean);
                fill(selects[idx+1], nextVals);
                selects[idx+1]._ts.addOptions(nextVals.map(v=>({value:v,text:v})));
            }
        });
    });

    fill(centroSel, window.centroList.map(c=>c[1]));
    new TomSelect(centroSel,{create:false});

    function fill(sel,vals){ sel.innerHTML = `<option value="">Selecione</option>` + vals.map(v=>`<option value="${v}">${v}</option>`).join(""); }
}

/* ================= ENVIO ================= */
async function submitForm(e){
    e.preventDefault();
    const msgS = document.getElementById("msgSuccess");
    const msgE = document.getElementById("msgError");
    msgS.style.display = msgE.style.display = "none";

    const fd = new FormData();
    fd.append("solicitante", solicitante.value);
    fd.append("emailSolicitante", emailSolicitante.value);
    fd.append("parceiro", parceiro.value);
    fd.append("docNumero", docNumero.value);
    fd.append("valorTotal", valorTotal.value);
    fd.append("competencia", competencia.value);
    fd.append("justificativa", justificativa.value);

    const rateios = [];
    document.querySelectorAll(".rateio-row").forEach(r=>{
        rateios.push({
            nivel1:r.querySelector('.n1').value,
            nivel2:r.querySelector('.n2').value,
            nivel3:r.querySelector('.n3').value,
            nivel4:r.querySelector('.n4').value,
            nivel5:r.querySelector('.n5').value,
            centro:r.querySelector('.centro').value,
            valorRateio:r.querySelector('.valorRateio').value,
        });
    });

    fd.append("rateioJson", JSON.stringify(rateios));

    for(const f of fileUpload.files){ fd.append("fileUpload", f); }

    try{
        const res = await fetch(API_URL,{method:"POST",body:fd});
        const data = await res.json();

        if(data.result === "success"){ msgS.style.display="block"; mainForm.reset(); return; }
        msgE.textContent = data.error || "Erro.";
        msgE.style.display="block";
    }catch(err){ msgE.style.display="block"; }
}
</script>
</body>
</html>
