<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Sistema de Reclassificação</title>

<!-- Bootstrap -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"/>

<!-- Tom Select -->
<link href="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/css/tom-select.css" rel="stylesheet"/>

<style>
    body {
        background: #f2f4f3;
        font-family: "Inter", sans-serif;
        padding: 30px;
    }

    /* Card padrão */
    .card-box {
        background: #fff;
        border-radius: 18px;
        padding: 28px;
        margin-bottom: 35px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.06);
    }

    h2.section-title {
        font-size: 22px;
        font-weight: 700;
        display: flex;
        align-items: center;
        margin-bottom: 22px;
    }

    h2.section-title img {
        height: 1.1em;
        margin-left: 8px;
    }

    .btn-main {
        background: #0f6c3f;
        color: #fff;
        border: none;
        padding: 10px 20px;
        border-radius: 10px;
        font-weight: 600;
        transition: .2s;
    }

    .btn-main:hover {
        background: #0b512f;
    }

    .rateioLinha {
        padding: 15px;
        background: #fafafa;
        border-radius: 12px;
        margin-bottom: 18px;
        border: 1px solid #e7e7e7;
    }

</style>
</head>
<body>

<!-- ========================= -->
<!-- BLOCO: BUSCA -->
<!-- ========================= -->
<div class="card-box">
    <h2 class="section-title">
        Rastreamento de Pedidos
        <!-- Ícone → trocar depois -->
        <img src="" alt="">
    </h2>

    <div class="row g-3 mb-3">
        <div class="col-md-8">
            <input id="searchInput" class="form-control" placeholder="Pesquisar por ID, Nome, Documento..."/>
        </div>
        <div class="col-md-4">
            <button class="btn-main w-100" onclick="searchRequests()">Buscar</button>
        </div>
    </div>

    <div class="table-responsive mt-3">
        <table class="table table-bordered" id="resultsTable">
            <thead class="table-light">
                <tr>
                    <th>ID</th><th>Solicitante</th><th>Doc Nº</th><th>Competência</th><th>Valor Total</th><th>Status</th><th>Quem Faz</th><th>Descrição</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
</div>


<!-- ========================= -->
<!-- BLOCO 1: SOLICITANTE -->
<!-- ========================= -->
<div class="card-box">
    <h2 class="section-title">
        1. Dados do Solicitante
        <!-- Ícone → trocar depois -->
        <img src="" alt="">
    </h2>

    <div class="row g-3 mb-4">
        <div class="col-md-3"><label>Solicitante</label><input id="solicitante" class="form-control"/></div>
        <div class="col-md-3"><label>E-mail</label><input id="email" class="form-control"/></div>
        <div class="col-md-3"><label>Nome do Parceiro</label><input id="parceiro" class="form-control"/></div>
        <div class="col-md-3"><label>Nº Documento</label><input id="numDocumento" class="form-control"/></div>
    </div>

    <div class="row g-3">
        <div class="col-md-3"><label>Valor Total</label><input id="valorTotal" class="form-control"/></div>
        <div class="col-md-3"><label>Competência</label><select id="competencia" class="form-select"></select></div>
    </div>
</div>


<!-- ========================= -->
<!-- BLOCO 2: RATEIO -->
<!-- ========================= -->
<div class="card-box">
    <h2 class="section-title">
        2. Rateio da Conta
        <!-- Ícone → trocar depois -->
        <img src="" alt="">
    </h2>

    <div id="rateioContainer"></div>

    <button class="btn-main mt-3" onclick="addRateioLinha()">+ Adicionar Rateio</button>
</div>


<!-- ========================= -->
<!-- ENVIAR -->
<!-- ========================= -->
<div class="text-end mb-5">
    <button class="btn-main" onclick="enviarFormulario()">Enviar Pedido</button>
</div>


<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/js/tom-select.complete.min.js"></script>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbwrJS1vjpqemqZtl3y9ZeGx-eCF1oQV486c-p01ZtXYpDMLKEpln63aOf-CoQpaBxRB/exec";

let listas = {};

window.onload = () => { carregarListas(); };

function carregarListas(){
    fetch(API_URL + "?action=get_options")
        .then(r => r.json())
        .then(data => {
            listas = data;
            carregarCompetencia(data);
        });
}

function carregarCompetencia(data){
    const select = document.getElementById("competencia");
    data.fixedLists.competenciaList.forEach(c => {
        const op = document.createElement("option");
        op.value = c;
        op.textContent = c;
        select.appendChild(op);
    });
}

/* ==========================================
   RATEIO — CASCATA COMPLETA
========================================== */
function addRateioLinha(){
    const linha = document.createElement("div");
    linha.className = "rateioLinha row g-3";

    linha.innerHTML = `
        <div class="col-md-2"><select class="form-select n1"><option value="">Natureza</option></select></div>
        <div class="col-md-2"><select class="form-select n2"><option value="">Área</option></select></div>
        <div class="col-md-2"><select class="form-select n3"><option value="">N3</option></select></div>
        <div class="col-md-2"><select class="form-select n4"><option value="">N4</option></select></div>
        <div class="col-md-2"><select class="form-select n5"><option value="">N5</option></select></div>
        <div class="col-md-2"><select class="form-select centro"><option value="">Centro</option></select></div>
        <div class="col-md-2"><input class="form-control valor" placeholder="Valor"/></div>
        <div class="col-md-1 text-end"><button class="btn btn-danger" onclick="this.closest('.rateioLinha').remove()">X</button></div>
    `;

    document.getElementById("rateioContainer").appendChild(linha);

    aplicarCascata(linha);
}

function aplicarCascata(linha){
    const ops = listas.cascadingOptions;
    const centros = listas.centroData;

    const n1 = linha.querySelector(".n1");
    const n2 = linha.querySelector(".n2");
    const n3 = linha.querySelector(".n3");
    const n4 = linha.querySelector(".n4");
    const n5 = linha.querySelector(".n5");
    const centro = linha.querySelector(".centro");

    function fill(select, values){
        select.innerHTML = `<option value=""></option>`;
        [...new Set(values)].forEach(v => {
            if(v) select.innerHTML += `<option value="${v}">${v}</option>`;
        });
    }

    fill(n1, ops.map(r => r[0]));

    n1.onchange = () => {
        fill(n2, ops.filter(r => r[0] === n1.value).map(r => r[1]));
        fill(n3, []); fill(n4, []); fill(n5, []); fill(centro, []);
    };

    n2.onchange = () => {
        fill(n3, ops.filter(r => r[1] === n2.value).map(r => r[2]));

        const listaCentros = centros.filter(r => r[0] === n2.value).map(r => r[1]);
        fill(centro, listaCentros);

        fill(n4, []); fill(n5, []);
    };

    n3.onchange = () => {
        fill(n4, ops.filter(r => r[2] === n3.value).map(r => r[3]));
        fill(n5, []);
    };

    n4.onchange = () => {
        fill(n5, ops.filter(r => r[3] === n4.value).map(r => r[4]));
    };
}

/* ==========================================
   ENVIO DO FORMULÁRIO
========================================== */
function enviarFormulario(){
    alert("Enviado! (backend será configurado depois)");
}

</script>
</body>
</html>
