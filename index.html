<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Sistema de Reclassificação</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
<link href="https://cdn.jsdelivr.net/npm/tom-select/dist/css/tom-select.css" rel="stylesheet" />

<style>
 body { background:#f2f4f3; padding:40px; font-family: "Inter", sans-serif; }
 .card-custom { background:#fff; border-radius:16px; padding:32px; box-shadow:0 4px 20px rgba(0,0,0,0.08); margin-bottom:40px; }
 h2.section-title { font-size:22px; font-weight:700; margin-bottom:20px; display:flex; align-items:center; }
 .btn-main { background:#0f6c3f; color:#fff; border:none; padding:10px 22px; border-radius:10px; font-weight:600; transition:.2s; }
 .btn-main:hover { background:#0c5733; }
</style>
</head>
<body>

<div class="card-custom">
  <h2 class="section-title">Rastreamento de Pedidos</h2>

  <div class="row g-3 mb-3">
    <div class="col-md-6">
      <input id="searchInput" class="form-control" placeholder="Pesquisar Solicitações... (mín. 3 chars)" />
    </div>
    <div class="col-md-3">
      <button class="btn-main w-100" onclick="searchRequests()">Buscar</button>
    </div>
  </div>

  <div class="table-responsive">
    <table class="table table-bordered" id="resultsTable">
      <thead class="table-light">
        <tr>
          <th>ID</th><th>Solicitante</th><th>Doc Nº</th><th>Competência</th>
          <th>Valor Total</th><th>Status</th><th>Quem Faz</th><th>Descrição</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<div class="card-custom">
  <h2 class="section-title">1. Dados do Solicitante</h2>

  <div class="row g-3 mb-4">
    <div class="col-md-4"><label>Solicitante</label><input id="solicitante" class="form-control" /></div>
    <div class="col-md-4"><label>E-mail</label><input id="email" class="form-control" /></div>
    <div class="col-md-4"><label>Descrição do Solicitante</label><textarea id="descricaoSolicitante" class="form-control" rows="2"></textarea></div>
  </div>
</div>

<div class="card-custom">
  <h2 class="section-title">2. Dados do Documento</h2>

  <div class="row g-3 mb-4">
    <div class="col-md-3"><label>Nome Parceiro</label><input id="parceiro" class="form-control" /></div>
    <div class="col-md-3"><label>Nº Documento</label><input id="numDocumento" class="form-control" /></div>
    <div class="col-md-3"><label>Valor Total</label><input id="valorTotal" type="number" class="form-control" /></div>
    <div class="col-md-3"><label>Competência</label><select id="competencia" class="form-select"></select></div>
  </div>

  <label>Descrição do Documento</label>
  <textarea id="descricaoDocumento" class="form-control mb-3" rows="3"></textarea>
</div>

<div class="card-custom">
  <h2 class="section-title">3. Rateio</h2>

  <div id="rateioContainer"></div>
  <button class="btn-main w-100" onclick="addRateioLinha()">+ Adicionar Rateio</button>
</div>

<div class="text-end">
  <button class="btn-main" onclick="enviarFormulario()">Enviar Pedido</button>
</div>

<div id="mensagem" class="alert mt-4" style="display:none"></div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/tom-select/dist/js/tom-select.complete.min.js"></script>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbwrJS1vjpqemqZtl3y9ZeGx-eCF1oQV486c-p01ZtXYpDMLKEpln63aOf-CoQpaBxRB/exec";
let listas = {};

window.onload = () => carregarListas();

function carregarListas(){
  fetch(API_URL + "?action=get_options")
    .then(r => r.json())
    .then(data => {
      listas = data;
      carregarCompetencia(data);
      addRateioLinha();
    });
}

function carregarCompetencia(data){
  const select = document.getElementById("competencia");
  select.innerHTML = '<option value="">Selecione</option>';
  (data.fixedLists?.competenciaList || []).forEach(c => {
    const op = document.createElement("option");
    op.value = c;
    op.textContent = c;
    select.appendChild(op);
  });
}

function addRateioLinha(){
  const linha = document.createElement("div");
  linha.className = "row g-3 mb-3 rateioLinha align-items-end";
  linha.innerHTML = `
    <div class="col-md-2"><select class="form-select n1"></select></div>
    <div class="col-md-2"><select class="form-select n2"></select></div>
    <div class="col-md-2"><select class="form-select n3"></select></div>
    <div class="col-md-2"><select class="form-select n4"></select></div>
    <div class="col-md-2"><select class="form-select n5"></select></div>
    <div class="col-md-2"><select class="form-select centro"></select></div>
    <div class="col-md-2 mt-2"><input class="form-control valor" type="number" placeholder="Valor" /></div>
    <div class="col-md-1 mt-2"><button class="btn btn-danger" onclick="this.closest('.rateioLinha').remove()">X</button></div>
  `;
  document.getElementById("rateioContainer").appendChild(linha);
  aplicarCascata(linha);
}

function aplicarCascata(linha){
  const n1 = linha.querySelector(".n1");
  const n2 = linha.querySelector(".n2");
  const n3 = linha.querySelector(".n3");
  const n4 = linha.querySelector(".n4");
  const n5 = linha.querySelector(".n5");
  const centro = linha.querySelector(".centro");

  const ops = listas.cascadingOptions || [];
  const centrosLista = listas.centroData || [];

  const preencher = (s, vals) => {
    s.innerHTML = '<option value=""></option>';
    vals.forEach(v => {
      const o = document.createElement("option");
      o.value = v;
      o.textContent = v;
      s.appendChild(o);
    });
  };

  preencher(n1, [...new Set(ops.map(r => r[0]).filter(Boolean))]);

  n1.onchange = () => preencher(n2, [...new Set(ops.filter(r => r[0] === n1.value).map(r => r[1]).filter(Boolean))]);
  n2.onchange = () => {
    preencher(centro, centrosLista.filter(r => r[0] === n2.value).map(r => r[1]));
    preencher(n3, [...new Set(ops.filter(r => r[1] === n2.value).map(r => r[2]).filter(Boolean))]);
  };
  n3.onchange = () => preencher(n4, [...new Set(ops.filter(r => r[2] === n3.value).map(r => r[3]).filter(Boolean))]);
  n4.onchange = () => preencher(n5, [...new Set(ops.filter(r => r[3] === n4.value).map(r => r[4]).filter(Boolean))]);
}

async function enviarFormulario(){
  try{
    const valores = [...document.querySelectorAll('.valor')].map(v => +v.value || 0);
    const soma = valores.reduce((a,b)=>a+b,0);
    const total = +document.getElementById("valorTotal").value || 0;

    if(Math.abs(soma - total) > 0.01){
      mostrarMensagem("danger","❌ O total do rateio deve bater com o valor total");
      return;
    }

    const formData = new FormData();

    formData.append("solicitante", solicitante.value);
    formData.append("emailSolicitante", email.value);
    formData.append("parceiro", parceiro.value);
    formData.append("docNumero", numDocumento.value);
    formData.append("valorTotal", total);
    formData.append("competencia", competencia.value);
    formData.append("justificativa", descricaoDocumento.value);

    const rateio = [...document.querySelectorAll(".rateioLinha")].map(r => ({
      nivel1: r.querySelector(".n1").value,
      nivel2: r.querySelector(".n2").value,
      nivel3: r.querySelector(".n3").value,
      nivel4: r.querySelector(".n4").value,
      nivel5: r.querySelector(".n5").value,
      centro: r.querySelector(".centro").value,
      valorRateio: +r.querySelector(".valor").value || 0
    }));

    formData.append("rateioJson", JSON.stringify(rateio));

    const resp = await fetch(API_URL,{ method:"POST", body:formData });
    const res = await resp.json();

    if(res.result === "success"){
      mostrarMensagem("success","✅ Pedido enviado com sucesso! ID: "+res.id);
    }else{
      throw new Error(res.error);
    }

  }catch(e){
    console.error(e);
    mostrarMensagem("danger","Erro ao enviar pedido. Veja o console.");
  }
}

function mostrarMensagem(tipo,msg){
  const m = document.getElementById("mensagem");
  m.className = "alert alert-"+tipo;
  m.innerHTML = msg;
  m.style.display = "block";
}

function searchRequests(){
  const q = searchInput.value.trim();
  if(q.length < 3) return;
  fetch(API_URL+"?action=search_requests&query="+encodeURIComponent(q))
    .then(r=>r.json())
    .then(d=>renderSearchResults(d.data||[]));
}

function renderSearchResults(results){
  const tb = document.querySelector("#resultsTable tbody");
  tb.innerHTML="";
  results.forEach(i=>{
    tb.innerHTML+=`
      <tr>
        <td>${i.id}</td><td>${i.solicitante}</td><td>${i.docNumero}</td>
        <td>${i.competencia}</td><td>${i.valorTotal}</td>
        <td>${i.status}</td><td>${i.quemFaz}</td><td>${i.descricao}</td>
      </tr>`;
  });
}
</script>
</body>
</html>
